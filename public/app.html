<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PageForge ‚Äî AI SEO Page Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fafafa;
    --surface: #ffffff;
    --border: #e5e7eb;
    --border-focus: #111;
    --text: #111;
    --muted: #6b7280;
    --subtle: #9ca3af;
    --accent: #111;
    --accent-hover: #333;
    --success: #16a34a;
    --error: #dc2626;
    --warning: #d97706;
    --chip-bg: #f3f4f6;
    --chip-active: #111;
    --step-line: #e5e7eb;
    --mono: 'Geist Mono', monospace;
    --sans: 'Geist', -apple-system, sans-serif;
    --radius: 10px;
    --radius-sm: 6px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 24px;
    z-index: 100;
    gap: 16px;
  }

  .logo {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-mark {
    width: 26px; height: 26px;
    background: #111;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    color: white;
    font-size: 13px;
  }

  .topbar-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    font-size: 11px;
    font-family: var(--mono);
    background: var(--chip-bg);
    color: var(--muted);
    padding: 3px 8px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  .badge.success { background: #f0fdf4; color: var(--success); border-color: #bbf7d0; }
  .badge.error { background: #fef2f2; color: var(--error); border-color: #fecaca; }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main {
    max-width: 640px;
    margin: 0 auto;
    padding: 88px 24px 80px;
  }

  /* ‚îÄ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ */
  .hero {
    text-align: center;
    margin-bottom: 48px;
  }

  .hero-eyebrow {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .hero-title {
    font-size: 32px;
    font-weight: 700;
    letter-spacing: -1px;
    line-height: 1.1;
    margin-bottom: 12px;
  }

  .hero-sub {
    font-size: 15px;
    color: var(--muted);
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ‚îÄ STEP FLOW ‚îÄ‚îÄ‚îÄ */
  .steps-container {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .step {
    display: flex;
    gap: 0;
    position: relative;
  }

  .step-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 40px;
    flex-shrink: 0;
  }

  .step-circle {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    flex-shrink: 0;
    transition: all 0.2s;
    position: relative;
    z-index: 1;
  }

  .step.active .step-circle {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }

  .step.done .step-circle {
    border-color: var(--success);
    background: #f0fdf4;
    color: var(--success);
  }

  .step-line {
    width: 1.5px;
    flex: 1;
    background: var(--step-line);
    margin: 4px 0;
    min-height: 24px;
  }

  .step.active .step-line,
  .step.done .step-line {
    background: var(--border);
  }

  .step-right {
    flex: 1;
    padding: 4px 0 36px 16px;
  }

  .step-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    height: 32px;
    cursor: pointer;
  }

  .step-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    transition: color 0.2s;
  }

  .step.active .step-title { color: var(--text); }
  .step.done .step-title { color: var(--text); }

  .step-subtitle {
    font-size: 12px;
    color: var(--subtle);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .step-content {
    display: none;
  }

  .step.active .step-content {
    display: block;
  }

  .step-summary {
    display: none;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
    font-family: var(--mono);
  }

  .step.done .step-summary {
    display: block;
  }

  /* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
  .field {
    margin-bottom: 16px;
  }

  .field:last-child { margin-bottom: 0; }

  label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--text);
  }

  .label-hint {
    font-weight: 400;
    color: var(--muted);
    font-size: 12px;
  }

  input[type="text"],
  input[type="password"],
  textarea,
  select {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    -webkit-appearance: none;
  }

  input[type="text"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(0,0,0,0.06);
  }

  textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
  }

  .hint-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.5;
  }

  .char-counter {
    font-size: 11px;
    font-family: var(--mono);
    margin-top: 5px;
    color: var(--muted);
  }

  .char-counter .count { font-weight: 600; }
  .char-counter .count.good { color: var(--success); }
  .char-counter .count.warn { color: var(--warning); }
  .char-counter .count.bad { color: var(--error); }

  /* ‚îÄ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ‚îÄ */
  .chip-group {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .chip {
    font-size: 12px;
    font-family: var(--mono);
    padding: 5px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--chip-bg);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }

  .chip:hover { border-color: #999; color: var(--text); }

  .chip.active {
    background: var(--chip-active);
    color: white;
    border-color: var(--chip-active);
  }

  /* keyword tag input */
  .keyword-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px;
    min-height: 46px;
    background: var(--surface);
    cursor: text;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .keyword-tags:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(0,0,0,0.06);
  }

  .kw-tag {
    display: flex;
    align-items: center;
    gap: 4px;
    background: var(--chip-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 12px;
    font-family: var(--mono);
    color: var(--text);
  }

  .kw-tag-remove {
    cursor: pointer;
    color: var(--subtle);
    font-size: 13px;
    line-height: 1;
    transition: color 0.1s;
  }

  .kw-tag-remove:hover { color: var(--error); }

  .kw-input {
    border: none;
    outline: none;
    font-size: 13px;
    font-family: var(--sans);
    min-width: 100px;
    flex: 1;
    background: transparent;
    color: var(--text);
  }

  /* slider */
  .slider-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  input[type="range"] {
    flex: 1;
    accent-color: var(--accent);
    cursor: pointer;
    height: 4px;
  }

  .slider-value {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    min-width: 70px;
    text-align: right;
  }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    font-family: var(--sans);
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--text);
    color: white;
    border-color: var(--text);
    width: 100%;
    padding: 12px;
    font-size: 14px;
  }

  .btn-primary:hover { background: #333; border-color: #333; }
  .btn-primary:active { transform: scale(0.99); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: var(--surface);
    color: var(--text);
    border-color: var(--border);
  }

  .btn-secondary:hover { border-color: #999; }

  .btn-sm {
    padding: 7px 14px;
    font-size: 13px;
  }

  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .btn-row .btn { flex: 1; }

  /* ‚îÄ‚îÄ‚îÄ STEP NAVIGATION ‚îÄ‚îÄ‚îÄ */
  .step-nav {
    margin-top: 20px;
  }

  /* ‚îÄ‚îÄ‚îÄ LOADING STATE ‚îÄ‚îÄ‚îÄ */
  .loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0;
  }

  .loading-overlay.active {
    display: flex;
  }

  .loading-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    width: 480px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08);
  }

  .loading-top {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
  }

  .loading-spinner {
    width: 40px; height: 40px;
    border: 2px solid var(--border);
    border-top-color: var(--text);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title-wrap {}
  .loading-title { font-size: 16px; font-weight: 600; }
  .loading-kw { font-size: 12px; color: var(--muted); margin-top: 2px; font-family: var(--mono); }

  .progress-bar-track {
    height: 3px;
    background: var(--border);
    border-radius: 99px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--text);
    border-radius: 99px;
    transition: width 0.6s ease;
    width: 0%;
  }

  .loading-steps { display: flex; flex-direction: column; gap: 0; }

  .lstep {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    opacity: 0.4;
    transition: opacity 0.3s;
  }

  .lstep:last-child { border-bottom: none; }

  .lstep.active { opacity: 1; }
  .lstep.done { opacity: 0.7; }

  .lstep-dot {
    width: 20px; height: 20px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 9px;
    flex-shrink: 0;
    margin-top: 1px;
    transition: all 0.3s;
  }

  .lstep.active .lstep-dot {
    border-color: var(--text);
    background: var(--text);
  }

  .lstep.active .lstep-dot::after {
    content: '';
    width: 6px; height: 6px;
    background: white;
    border-radius: 50%;
    animation: blink 1s ease infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .lstep.done .lstep-dot {
    border-color: var(--success);
    background: var(--success);
    color: white;
  }

  .lstep.done .lstep-dot::after {
    content: '‚úì';
    font-size: 10px;
    font-weight: 700;
    color: white;
  }

  .lstep-label { font-size: 13px; font-weight: 500; }
  .lstep-sub { font-size: 11px; color: var(--muted); margin-top: 1px; font-family: var(--mono); }

  .loading-footer {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--subtle);
    font-family: var(--mono);
  }

  /* ‚îÄ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ‚îÄ */
  .result-section {
    display: none;
  }

  .result-section.visible { display: block !important; }

  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-top: 32px;
  }

  .result-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .result-title {
    font-size: 14px;
    font-weight: 600;
  }

  .result-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
  }

  .rtab {
    padding: 10px 14px;
    font-size: 12px;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    border: none;
    background: none;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    font-family: var(--sans);
    margin-bottom: -1px;
  }

  .rtab:hover { color: var(--text); }
  .rtab.active { color: var(--text); border-bottom-color: var(--text); }

  .rtab-panel { display: none; }
  .rtab-panel.active { display: block; }

  .preview-browser {
    background: #f5f5f5;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--border);
  }

  .browser-dots {
    display: flex; gap: 5px;
  }

  .bdot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }

  .url-pill {
    flex: 1;
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--muted);
  }

  iframe#previewFrame {
    width: 100%;
    height: 480px;
    border: none;
    display: block;
    background: white;
  }

  .score-panel { padding: 20px; }

  .score-big {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .score-ring-wrap {
    position: relative;
    width: 72px; height: 72px;
    flex-shrink: 0;
  }

  .score-ring-wrap svg { transform: rotate(-90deg); }

  .score-ring-center {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 700;
  }

  .score-info {}
  .score-label { font-size: 18px; font-weight: 700; }
  .score-sublabel { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .rules-list { display: flex; flex-direction: column; gap: 1px; }

  .rule-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 0;
    font-size: 12px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
  }

  .rule-row:last-child { border-bottom: none; }

  .rule-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
  }

  .rule-row.pass { color: var(--text); }
  .rule-row.pass .rule-dot { background: var(--success); }
  .rule-row.fail .rule-dot { background: var(--error); }
  .rule-row.fail { color: var(--muted); }

  .code-panel { position: relative; }

  .code-toolbar {
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .code-label { font-size: 11px; color: var(--muted); font-family: var(--mono); }

  pre {
    margin: 0;
    padding: 20px;
    font-family: var(--mono);
    font-size: 11px;
    line-height: 1.7;
    color: #374151;
    max-height: 400px;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-all;
    background: var(--bg);
  }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--text);
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    z-index: 999;
    transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.error { background: var(--error); }
  .toast.success { background: var(--success); }

  hr.field-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 20px 0;
  }

  .step-edit-btn {
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--chip-bg);
    border: 1px solid var(--border);
    font-family: var(--mono);
    transition: all 0.1s;
    margin-left: auto;
    display: none;
  }

  .step.done .step-edit-btn { display: inline-flex; align-items: center; }
  .step-edit-btn:hover { border-color: #999; color: var(--text); }

  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .step:last-child .step-right {
    padding-bottom: 0;
  }

  .step:last-child .step-line {
    display: none;
  }

  /* ‚îÄ‚îÄ‚îÄ DIVI TOGGLE ‚îÄ‚îÄ‚îÄ */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    cursor: pointer;
    user-select: none;
    transition: border-color 0.15s;
  }
  .toggle-row:hover { border-color: var(--border-focus); }
  .toggle-label { font-size: 13px; font-weight: 500; color: var(--text); }
  .toggle-desc  { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .toggle-track {
    width: 40px; height: 22px; border-radius: 99px;
    background: var(--border); position: relative;
    transition: background 0.2s; flex-shrink: 0;
  }
  .toggle-track.on { background: #111; }
  .toggle-thumb {
    width: 18px; height: 18px; border-radius: 50%;
    background: white; position: absolute;
    top: 2px; left: 2px;
    transition: left 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
  }
  .toggle-track.on .toggle-thumb { left: 20px; }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">
    <div class="logo-mark">‚ö°</div>
    PageForge
  </div>
  <div class="topbar-right" id="topbarRight">
    <a href="/dashboard" style="font-size:13px;color:var(--muted);text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:#fff;">‚Üê Dashboard</a>
    <button onclick="signOut()" style="font-size:13px;color:var(--muted);background:none;border:none;cursor:pointer;padding:6px;">Sign out</button>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-card">
    <div class="loading-top">
      <div class="loading-spinner"></div>
      <div class="loading-title-wrap">
        <div class="loading-title">Generating your SEO page</div>
        <div class="loading-kw" id="loadingKw">Powered by Claude AI</div>
      </div>
    </div>

    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>

    <div class="loading-steps">
      <div class="lstep" id="ls1">
        <div class="lstep-dot"></div>
        <div>
          <div class="lstep-label">Analyzing keyword strategy</div>
          <div class="lstep-sub">focus & semantic keyword mapping</div>
        </div>
      </div>
      <div class="lstep" id="ls2">
        <div class="lstep-dot"></div>
        <div>
          <div class="lstep-label">Generating SEO content</div>
          <div class="lstep-sub">writing body copy & headings</div>
        </div>
      </div>
      <div class="lstep" id="ls3">
        <div class="lstep-dot"></div>
        <div>
          <div class="lstep-label">Building schema markup</div>
          <div class="lstep-sub">JSON-LD, FAQ & BreadcrumbList</div>
        </div>
      </div>
      <div class="lstep" id="ls4">
        <div class="lstep-dot"></div>
        <div>
          <div class="lstep-label">Applying 20 SEO rules</div>
          <div class="lstep-sub">meta tags, OG, Twitter Card, alts</div>
        </div>
      </div>
      <div class="lstep" id="ls5">
        <div class="lstep-dot"></div>
        <div>
          <div class="lstep-label">Finalizing design & CSS</div>
          <div class="lstep-sub">responsive layout, mobile styles</div>
        </div>
      </div>
    </div>

    <div class="loading-footer">
      <span id="loadingStep">Starting up...</span>
      <span id="loadingTimer">0s</span>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-eyebrow">Powered by Claude AI</div>
    <h1 class="hero-title" id="heroTitle">SEO-optimized pages,<br>in seconds.</h1>
    <p class="hero-sub" id="heroSub">Generate WordPress-ready HTML with full SEO optimization ‚Äî schema markup, meta tags, and 20-point SEO scoring.</p>

    <!-- MODE SWITCHER -->
    <div style="display:inline-flex;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-top:20px;background:var(--bg);">
      <button id="modePageBtn" onclick="switchMode('page')"
        style="padding:8px 20px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:all 0.15s;font-family:var(--sans);background:#111;color:#fff;">
        üìÑ Page Builder
      </button>
      <button id="modeSiloBtn" onclick="switchMode('silo')"
        style="padding:8px 20px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:all 0.15s;font-family:var(--sans);background:transparent;color:var(--muted);">
        üèó Silo Builder
      </button>
    </div>
  </div>

  <!-- PAGE BUILDER SECTION -->
  <div id="pageBuilderSection">
  <!-- STEPS -->
  <div class="steps-container">

    <!-- STEP 1: Keyword & Type -->
    <div class="step active" id="step1">
      <div class="step-left">
        <div class="step-circle">1</div>
        <div class="step-line"></div>
      </div>
      <div class="step-right">
        <div class="step-header" onclick="editStep(1)">
          <div class="step-title">Define your target keywords</div>
          <span class="step-edit-btn">Edit</span>
        </div>
        <div class="step-summary" id="summary1"></div>
        <div class="step-content">
          <div class="step-subtitle">Your primary keyword drives all SEO optimization decisions.</div>
          <div class="field">
            <label>Focus Keyword <span class="label-hint">‚Äî the main term you want to rank for</span></label>
            <input type="text" id="focusKeyword" placeholder="e.g. CBD oil benefits" oninput="updateFocusKw()">
          </div>
          <div class="field">
            <label>Secondary Keywords <span class="label-hint">‚Äî press Enter or comma to add</span></label>
            <div class="keyword-tags" id="kwTags" onclick="document.getElementById('kwInput').focus()">
              <input type="text" class="kw-input" id="kwInput" placeholder="Add related keywords...">
            </div>
          </div>
          <div class="field">
            <label>Page Type</label>
            <select id="pageType">
              <option value="pillar">Pillar / Educational Article</option>
              <option value="product">Product Page</option>
              <option value="landing">Landing Page</option>
              <option value="blog">Blog Post</option>
              <option value="local">Local Business Page</option>
              <option value="faq">FAQ Page</option>
              <option value="comparison">Comparison Page</option>
            </select>
          </div>
          <div class="step-nav">
            <button class="btn btn-primary" onclick="completeStep1()">Continue ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2: Page details -->
    <div class="step" id="step2">
      <div class="step-left">
        <div class="step-circle">2</div>
        <div class="step-line"></div>
      </div>
      <div class="step-right">
        <div class="step-header" onclick="editStep(2)">
          <div class="step-title">Page details & settings</div>
          <span class="step-edit-btn">Edit</span>
        </div>
        <div class="step-summary" id="summary2"></div>
        <div class="step-content">
          <div class="step-subtitle">Configure how your page should be generated.</div>
          <div class="two-col">
            <div class="field">
              <label>Site Name</label>
              <input type="text" id="siteName" placeholder="My Website">
            </div>
            <div class="field">
              <label>Content Tone</label>
              <select id="tone">
                <option value="professional">Professional</option>
                <option value="friendly">Friendly</option>
                <option value="medical">Medical / Clinical</option>
                <option value="technical">Technical</option>
                <option value="marketing">Marketing</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>Page Title <span class="label-hint">‚Äî 50‚Äì65 chars ideal</span></label>
            <input type="text" id="pageTitle" placeholder="e.g. CBD Oil Benefits: Complete Guide | My Site" oninput="updateTitleCount()">
            <div class="char-counter">
              <span class="count" id="titleCount">0</span> chars
              <span style="color:var(--muted);"> ¬∑ ideal 50‚Äì65</span>
            </div>
          </div>
          <div class="field">
            <label>Page Slug <span class="label-hint">‚Äî URL-safe, no spaces, use hyphens</span></label>
            <div style="display:flex;align-items:center;gap:0;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--surface);transition:border-color 0.15s,box-shadow 0.15s;" id="slugWrap">
              <span style="padding:10px 10px 10px 12px;font-size:13px;color:var(--muted);font-family:var(--mono);white-space:nowrap;border-right:1px solid var(--border);background:var(--bg);">/</span>
              <input type="text" id="pageSlug" placeholder="my-page-slug" oninput="onSlugInput()"
                style="border:none;border-radius:0;box-shadow:none;flex:1;font-family:var(--mono);font-size:13px;"
                onfocus="document.getElementById('slugWrap').style.borderColor='var(--border-focus)';document.getElementById('slugWrap').style.boxShadow='0 0 0 3px rgba(0,0,0,0.06)'"
                onblur="document.getElementById('slugWrap').style.borderColor='var(--border)';document.getElementById('slugWrap').style.boxShadow='none';sanitizeSlug()">
              <span id="slugStatus" style="padding:10px 10px;font-size:11px;color:var(--muted);font-family:var(--mono);white-space:nowrap;"></span>
            </div>
            <div class="hint-text">Auto-generated from your focus keyword ‚Äî edit freely. Used exactly as-is in your URL.</div>
          </div>
          <div class="field">
            <label>Target URL <span class="label-hint">‚Äî auto-built from slug, or override</span></label>
            <input type="text" id="targetUrl" placeholder="https://example.com/my-page/" oninput="slugUrlManual=true">
          </div>
          <div class="field">
            <label>Target Word Count</label>
            <div class="slider-wrap">
              <input type="range" id="wordCount" min="300" max="5000" step="100" value="1000" oninput="updateWC()">
              <span class="slider-value" id="wcDisplay">1,000 words</span>
            </div>
            <div class="hint-text" id="wcHint">Good for most blog posts and landing pages.</div>
          </div>
          <div class="field">
            <label>Schema Markup Types</label>
            <div class="chip-group" id="schemaChips">
              <div class="chip active" data-schema="Article">Article</div>
              <div class="chip active" data-schema="FAQPage">FAQ</div>
              <div class="chip active" data-schema="BreadcrumbList">Breadcrumb</div>
              <div class="chip" data-schema="HowTo">HowTo</div>
              <div class="chip" data-schema="Product">Product</div>
              <div class="chip" data-schema="LocalBusiness">LocalBusiness</div>
              <div class="chip" data-schema="Review">Review</div>
            </div>
          </div>

          <hr class="field-divider">

          <div class="field">
            <label>Brand Colors <span class="label-hint">‚Äî Claude will apply these to headings &amp; CTA box CSS</span></label>
            <div id="pageBrandColorsWrap">
              <textarea id="pageBrandColors" rows="3" placeholder="Examples:&#10;H1: #1d4ed8, H2: #374151, H3: #6b7280, CTA: #f59e0b&#10;H1 dark navy, H2 slate, H3 light grey, CTA gold&#10;https://example.com ‚Äî or just: forest green and cream"></textarea>
              <div class="hint-text">Specify per heading level or describe overall brand colors. Leave blank for default styling.</div>
            </div>
          </div>

          <div class="field">
            <label>Theme CSS Control</label>
            <div class="toggle-row" onclick="toggleDivi('page')">
              <div>
                <div class="toggle-label">Let Divi control all CSS</div>
                <div class="toggle-desc">Strips all inline styles ‚Äî Divi's theme builder handles heading colors, fonts, and spacing</div>
              </div>
              <div class="toggle-track" id="pageDiviTrack">
                <div class="toggle-thumb" id="pageDiviThumb"></div>
              </div>
            </div>
            <div class="hint-text" id="pageDiviHint">Off ‚Äî generated page includes its own scoped CSS.</div>
          </div>
          <div class="step-nav">
            <button class="btn btn-primary" onclick="completeStep2()">Continue ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 3: Generate -->
    <div class="step" id="step3">
      <div class="step-left">
        <div class="step-circle">3</div>
      </div>
      <div class="step-right">
        <div class="step-header">
          <div class="step-title">Generate your page</div>
        </div>
        <div class="step-content">
          <div class="step-subtitle">Review your configuration, then generate. Claude will build a fully SEO-optimized, WordPress-ready HTML page.</div>

          <div id="configSummary" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;font-size:13px;line-height:2;">
          </div>

          <button class="btn btn-primary" onclick="generatePage()" id="generateBtn" style="font-size:15px;padding:14px;">
            ‚ö° Generate SEO Page
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- RESULT -->
  <div class="result-section" id="resultSection">
    <div class="result-card">
      <div class="result-header">
        <div class="result-title">Generated Page</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:12px;color:var(--muted);font-family:var(--mono);" id="seoScoreBadge"></span>
          <button class="btn btn-secondary btn-sm" onclick="downloadPage()">‚¨á Download</button>
          <button class="btn btn-secondary btn-sm" onclick="copyCode()">‚éò Copy</button>
        </div>
      </div>

      <div class="result-tabs">
        <button class="rtab active" onclick="switchRTab('preview', this)">Preview</button>
        <button class="rtab" onclick="switchRTab('score', this)">SEO Score</button>
        <button class="rtab" onclick="switchRTab('code', this)">Code</button>
      </div>

      <!-- Preview -->
      <div class="rtab-panel active" id="rp-preview">
        <div class="preview-browser">
          <div class="browser-dots">
            <div class="bdot" style="background:#ff5f57"></div>
            <div class="bdot" style="background:#ffbd2e"></div>
            <div class="bdot" style="background:#28c840"></div>
          </div>
          <div class="url-pill" id="previewUrl">about:blank</div>
          <button class="btn btn-secondary btn-sm" style="padding:4px 10px;font-size:11px;" onclick="openInNew()">‚Üó</button>
        </div>
        <iframe id="previewFrame"></iframe>
      </div>

      <!-- SEO Score -->
      <div class="rtab-panel" id="rp-score">
        <div class="score-panel">
          <div class="score-big">
            <div class="score-ring-wrap">
              <svg width="72" height="72" viewBox="0 0 72 72">
                <circle cx="36" cy="36" r="28" fill="none" stroke="var(--border)" stroke-width="5"/>
                <circle id="scoreCircle" cx="36" cy="36" r="28" fill="none" stroke="#111" stroke-width="5"
                  stroke-dasharray="175.9" stroke-dashoffset="175.9" stroke-linecap="round"
                  style="transition:stroke-dashoffset 1s ease, stroke 0.5s ease"/>
              </svg>
              <div class="score-ring-center" id="scoreNum">‚Äî</div>
            </div>
            <div class="score-info">
              <div class="score-label" id="scoreLabel">‚Äî</div>
              <div class="score-sublabel" id="scoreSubLabel">Generate a page to see your score</div>
            </div>
          </div>
          <div class="rules-list" id="rulesList"></div>
        </div>
      </div>

      <!-- Code -->
      <div class="rtab-panel" id="rp-code">
        <div class="code-toolbar">
          <span class="code-label" id="codeLines">0 lines</span>
          <button class="btn btn-secondary btn-sm" onclick="copyCode()">Copy</button>
        </div>
        <pre id="codeBlock"><!-- Generated code will appear here --></pre>
      </div>
    </div>
  </div>

</div><!-- /pageBuilderSection -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SILO BUILDER SECTION
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="siloBuilderSection" style="display:none;">
    <div class="steps-container">

      <!-- SILO STEP 1: Pillar Page -->
      <div class="step active" id="siloStep1">
        <div class="step-left">
          <div class="step-circle">1</div>
          <div class="step-line"></div>
        </div>
        <div class="step-right">
          <div class="step-header" onclick="editSiloStep(1)">
            <div class="step-title">Pillar page</div>
            <span class="step-edit-btn">Edit</span>
          </div>
          <div class="step-summary" id="siloSummary1"></div>
          <div class="step-content">
            <div class="step-subtitle">Define your silo's hub page ‚Äî the pillar all child posts will link back to.</div>

            <div class="field">
              <label>Pillar Title</label>
              <input type="text" id="pillarTitle" placeholder="e.g. The Complete Guide to Organic Gardening">
            </div>

            <div class="field">
              <label>Pillar Slug <span class="label-hint">‚Äî URL-safe, hyphens only</span></label>
              <div style="display:flex;align-items:center;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--surface);transition:border-color 0.15s;" id="pillarSlugWrap">
                <span style="padding:10px 10px 10px 12px;font-size:13px;color:var(--muted);font-family:var(--mono);white-space:nowrap;border-right:1px solid var(--border);background:var(--bg);">/</span>
                <input type="text" id="pillarSlug" placeholder="organic-gardening" oninput="onPillarSlugInput()"
                  style="border:none;border-radius:0;box-shadow:none;flex:1;font-family:var(--mono);font-size:13px;"
                  onfocus="document.getElementById('pillarSlugWrap').style.borderColor='var(--border-focus)'"
                  onblur="document.getElementById('pillarSlugWrap').style.borderColor='var(--border)';sanitizePillarSlug()">
              </div>
            </div>

            <div class="two-col">
              <div class="field">
                <label>Primary Keyword</label>
                <input type="text" id="pillarPrimaryKw" placeholder="e.g. organic gardening">
              </div>
              <div class="field">
                <label>Site URL <span class="label-hint">‚Äî optional</span></label>
                <input type="text" id="siloSiteUrl" placeholder="https://example.com">
              </div>
            </div>

            <div class="field">
              <label>Secondary Keywords <span class="label-hint">‚Äî press Enter or comma to add</span></label>
              <div class="keyword-tags" id="pillarKwTags" onclick="document.getElementById('pillarKwInput').focus()">
                <input type="text" class="kw-input" id="pillarKwInput" placeholder="Add secondary keywords...">
              </div>
            </div>

            <div class="field">
              <label>Related Silos to Cross-link <span class="label-hint">‚Äî optional, press Enter to add</span></label>
              <div class="keyword-tags" id="crossSiloTags" onclick="document.getElementById('crossSiloInput').focus()">
                <input type="text" class="kw-input" id="crossSiloInput" placeholder="e.g. /composting/ or Composting Guide...">
              </div>
            </div>

            <div class="field">
              <label>Words Per Page <span class="label-hint">‚Äî applied to every page in the silo</span></label>
              <div class="slider-wrap">
                <input type="range" id="siloWordCount" min="500" max="5000" step="100" value="1500" oninput="updateSiloWC()">
                <span class="slider-value" id="siloWcDisplay">1,500 words</span>
              </div>
              <div class="hint-text" id="siloWcHint">Good balance of depth and generation speed for most silo pages.</div>
            </div>

            <hr class="field-divider">

            <div class="field">
              <label>Brand Colors <span class="label-hint">‚Äî Claude will apply these to headings &amp; CTA box across all silo pages</span></label>
              <div id="siloBrandColorsWrap">
                <textarea id="siloBrandColors" rows="3" placeholder="Examples:&#10;H1: #1d4ed8, H2: #374151, H3: #6b7280, CTA: #f59e0b&#10;H1 dark navy, H2 slate, H3 light grey, CTA gold&#10;https://gardenwiseguy.com ‚Äî or just: forest green and cream"></textarea>
                <div class="hint-text">Specify per heading level or describe overall brand colors. Leave blank for default styling.</div>
              </div>
            </div>

            <div class="field">
              <label>Theme CSS Control</label>
              <div class="toggle-row" onclick="toggleDivi('silo')">
                <div>
                  <div class="toggle-label">Let Divi control all CSS</div>
                  <div class="toggle-desc">Strips all inline styles ‚Äî Divi's theme builder handles heading colors, fonts, and spacing</div>
                </div>
                <div class="toggle-track" id="siloDiviTrack">
                  <div class="toggle-thumb" id="siloDiviThumb"></div>
                </div>
              </div>
              <div class="hint-text" id="siloDiviHint">Off ‚Äî generated pages include their own scoped CSS.</div>
            </div>

            <div class="step-nav">
              <button class="btn btn-primary" onclick="completeSiloStep1()">Continue ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SILO STEP 2: Child Posts -->
      <div class="step" id="siloStep2">
        <div class="step-left">
          <div class="step-circle">2</div>
          <div class="step-line"></div>
        </div>
        <div class="step-right">
          <div class="step-header" onclick="editSiloStep(2)">
            <div class="step-title">Child posts</div>
            <span class="step-edit-btn">Edit</span>
          </div>
          <div class="step-summary" id="siloSummary2"></div>
          <div class="step-content">
            <div class="step-subtitle">Add the posts that live under this silo. Each gets its own slug, primary keyword, and optional secondary keywords.</div>

            <div id="childPostsList"></div>

            <button class="btn btn-secondary" onclick="addChildPost()" style="width:100%;margin-top:4px;">
              + Add Child Post
            </button>

            <div class="step-nav" style="margin-top:16px;">
              <button class="btn btn-primary" onclick="completeSiloStep2()">Continue ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SILO STEP 3: Generate Blueprint -->
      <div class="step" id="siloStep3">
        <div class="step-left">
          <div class="step-circle">3</div>
        </div>
        <div class="step-right">
          <div class="step-header">
            <div class="step-title">Generate silo blueprint</div>
          </div>
          <div class="step-content">
            <div class="step-subtitle">Review your silo structure, then generate a full blueprint with URL map, page outlines, and interlinking strategy.</div>
            <div id="siloConfigSummary" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;font-size:13px;line-height:2;"></div>
            <button class="btn btn-primary" onclick="generateSilo()" id="generateSiloBtn" style="font-size:15px;padding:14px;">
              üèó Generate Silo Blueprint
            </button>
          </div>
        </div>
      </div>

    </div><!-- /silo steps-container -->

    <!-- SILO RESULT -->
    <div class="result-section" id="siloResultSection">
      <div class="result-card">
        <div class="result-header">
          <div class="result-title">Silo Blueprint</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn btn-secondary btn-sm" onclick="copySiloBlueprint()">‚éò Copy</button>
            <button class="btn btn-secondary btn-sm" onclick="downloadSiloBlueprint()">‚¨á .txt</button>
          </div>
        </div>
        <div style="padding:24px 24px 0;">
          <pre id="siloBlueprintOutput" style="white-space:pre-wrap;word-break:break-word;font-family:var(--mono);font-size:12px;line-height:1.8;color:#374151;max-height:500px;overflow:auto;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;"></pre>
        </div>

        <!-- BUILD PAGES PANEL -->
        <div style="padding:24px;border-top:1px solid var(--border);margin-top:24px;">
          <div style="margin-bottom:16px;">
            <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Build Page Content</div>
            <div style="font-size:13px;color:var(--muted);">Generate full WordPress-ready HTML for every page in your silo, then download as a zip.</div>
          </div>

          <!-- STATUS BAR (hidden until building) -->
          <div id="buildStatusPanel" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <span style="font-size:13px;font-weight:600;" id="buildStatusTitle">Building pages...</span>
              <span style="font-size:12px;font-family:var(--mono);color:var(--muted);" id="buildStatusCount">0 / 0</span>
            </div>
            <div style="height:6px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:12px;">
              <div id="buildProgressFill" style="height:100%;background:#111;border-radius:99px;width:0%;transition:width 0.4s ease;"></div>
            </div>
            <div id="buildPageRows" style="display:flex;flex-direction:column;gap:6px;"></div>
          </div>

          <div style="display:flex;gap:8px;">
            <button class="btn btn-primary" id="buildPagesBtn" onclick="buildSiloPages()" style="flex:1;font-size:14px;padding:12px;">
              ‚ö° Build All Pages
            </button>
            <button class="btn btn-secondary btn-sm" id="downloadZipBtn" onclick="downloadSiloZip()" style="display:none;padding:12px 18px;">
              ‚¨á Download Zip
            </button>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /siloBuilderSection -->

</div><!-- /main -->

<div class="toast" id="toast"></div>

<script>

// ‚îÄ‚îÄ‚îÄ ACCESS GUARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  try {
    const s = JSON.parse(localStorage.getItem('pf_session') || '{}');
    if (!s.email) {
      window.location.href = '/?needsAccess=true';
    }
  } catch(e) {
    window.location.href = '/';
  }
})();

// ‚îÄ‚îÄ‚îÄ SESSION HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSession() {
  try { return JSON.parse(localStorage.getItem('pf_session') || '{}'); } catch(e) { return {}; }
}
function signOut() {
  if (!confirm('Sign out?')) return;
  localStorage.removeItem('pf_session');
  window.location.href = '/';
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let currentStep = 1;
let secKeywords = [];
let schemaTypes = ['Article', 'FAQPage', 'BreadcrumbList'];
let generatedHTML = '';

const SEO_RULES = [
  { id: 'title',       label: 'Page title tag (50‚Äì65 chars)',         check: d => d.titleLen >= 50 && d.titleLen <= 65 },
  { id: 'metaDesc',    label: 'Meta description (120‚Äì160 chars)',      check: d => d.metaLen >= 120 && d.metaLen <= 160 },
  { id: 'metaKw',      label: 'Keyword in meta description',          check: d => d.metaHasKw },
  { id: 'h1',          label: 'Single H1 tag',                        check: d => d.h1Count === 1 },
  { id: 'h1kw',        label: 'Focus keyword in H1',                  check: d => d.h1HasKw },
  { id: 'h2s',         label: 'Multiple H2 subheadings (5+)',          check: d => d.h2Count >= 5 },
  { id: 'firstPara',   label: 'Keyword in first paragraph',           check: d => d.firstParaHasKw },
  { id: 'canonical',   label: 'Canonical URL present',                check: d => d.hasCanonical },
  { id: 'schema',      label: 'JSON-LD schema markup',                check: d => d.hasSchema },
  { id: 'faqSchema',   label: 'FAQPage schema included',              check: d => d.hasFaqSchema },
  { id: 'breadcrumb',  label: 'BreadcrumbList schema',                check: d => d.hasBreadcrumb },
  { id: 'imgAlts',     label: 'All images have alt attributes',       check: d => d.imgsMissingAlt === 0 },
  { id: 'ogTags',      label: 'Open Graph tags (og:title, og:desc)',  check: d => d.hasOg },
  { id: 'twitterCard', label: 'Twitter Card tags',                    check: d => d.hasTwitter },
  { id: 'wordCount',   label: 'Content length meets target',          check: d => d.wordCount >= (window._targetWordCount || 1000) },
  { id: 'internalLinks',label: 'Internal anchor links (3+)',          check: d => d.internalLinks >= 3 },
  { id: 'faqSection',  label: 'FAQ section with 5+ Q&As',            check: d => d.faqCount >= 5 },
  { id: 'headingFlow', label: 'No skipped heading levels',           check: d => d.headingFlowOk },
  { id: 'secKeywords', label: 'Secondary keywords used',             check: d => d.secKwUsed },
  { id: 'style',       label: 'Scoped CSS styles included',          check: d => d.hasStyle },
];

// ‚îÄ‚îÄ‚îÄ STEP MANAGEMENT ‚îÄ‚îÄ‚îÄ
function goToStep(n) {
  document.querySelectorAll('.step').forEach((el, i) => {
    const num = i + 1;
    el.classList.remove('active', 'done');
    if (num < n) el.classList.add('done');
    if (num === n) el.classList.add('active');
  });
  currentStep = n;
  if (n === 3) buildConfigSummary();
}

function editStep(n) {
  if (currentStep > n) {
    if (n === 1) { slugManuallyEdited = false; slugUrlManual = false; }
    goToStep(n);
  }
}

function completeStep1() {
  const kw = document.getElementById('focusKeyword').value.trim();
  if (!kw) { showToast('error', 'Please enter a focus keyword'); return; }
  const type = document.getElementById('pageType').selectedOptions[0].text;
  const secondary = secKeywords.length ? ` + ${secKeywords.length} secondary` : '';
  document.getElementById('summary1').textContent = `"${kw}"${secondary} ¬∑ ${type}`;
  goToStep(2);
}

function completeStep2() {
  const wc = document.getElementById('wordCount').value;
  const tone = document.getElementById('tone').selectedOptions[0].text;
  document.getElementById('summary2').textContent = `${parseInt(wc).toLocaleString()} words ¬∑ ${tone} tone ¬∑ ${schemaTypes.length} schema types`;
  goToStep(3);
}

// ‚îÄ‚îÄ‚îÄ KEYWORD TAGS ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('kwInput');
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      const val = input.value.replace(/,$/, '').trim();
      if (val && !secKeywords.includes(val)) {
        secKeywords.push(val);
        renderKwTags();
      }
      input.value = '';
    }
    if (e.key === 'Backspace' && !input.value && secKeywords.length) {
      secKeywords.pop();
      renderKwTags();
    }
  });

  initSchemaChips();
  renderRulesList();
  updateWC();
});

function renderKwTags() {
  const container = document.getElementById('kwTags');
  const input = document.getElementById('kwInput');
  container.innerHTML = '';
  secKeywords.forEach((kw, i) => {
    const tag = document.createElement('span');
    tag.className = 'kw-tag';
    tag.innerHTML = `${kw}<span class="kw-tag-remove" onclick="removeKw(${i})">√ó</span>`;
    container.appendChild(tag);
  });
  container.appendChild(input);
  input.focus();
}

function removeKw(i) {
  secKeywords.splice(i, 1);
  renderKwTags();
}

// ‚îÄ‚îÄ‚îÄ SCHEMA CHIPS ‚îÄ‚îÄ‚îÄ
function initSchemaChips() {
  document.querySelectorAll('#schemaChips .chip').forEach(chip => {
    chip.addEventListener('click', () => {
      chip.classList.toggle('active');
      const s = chip.dataset.schema;
      if (chip.classList.contains('active')) {
        if (!schemaTypes.includes(s)) schemaTypes.push(s);
      } else {
        schemaTypes = schemaTypes.filter(x => x !== s);
      }
    });
  });
}

// ‚îÄ‚îÄ‚îÄ FORM HELPERS ‚îÄ‚îÄ‚îÄ
function updateTitleCount() {
  const len = document.getElementById('pageTitle').value.length;
  const el = document.getElementById('titleCount');
  el.textContent = len;
  el.className = 'count ' + (len >= 50 && len <= 65 ? 'good' : len > 0 && len < 50 ? 'warn' : len > 65 ? 'bad' : '');
}

function updateWC() {
  const v = parseInt(document.getElementById('wordCount').value);
  document.getElementById('wcDisplay').textContent = v.toLocaleString() + ' words';
  const hint = v < 600 ? 'Good for quick FAQ or thin landing pages.'
    : v < 1500 ? 'Good for most blog posts and landing pages.'
    : v < 3000 ? 'Ideal for pillar pages and comprehensive guides.'
    : 'Deep-dive content for topical authority.';
  document.getElementById('wcHint').textContent = hint;
}

let slugManuallyEdited = false;
let slugUrlManual = false;

function kwToSlug(kw) {
  return kw.toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}

function updateFocusKw() {
  const kw = document.getElementById('focusKeyword').value.trim();
  // Only auto-fill slug if user hasn't manually edited it
  if (!slugManuallyEdited) {
    const slug = kwToSlug(kw);
    document.getElementById('pageSlug').value = slug;
    updateUrlFromSlug(slug);
  }
}

function onSlugInput() {
  slugManuallyEdited = true;
  const raw = document.getElementById('pageSlug').value;
  updateUrlFromSlug(raw);
  showSlugStatus(raw);
}

function sanitizeSlug() {
  const el = document.getElementById('pageSlug');
  const clean = kwToSlug(el.value);
  el.value = clean;
  updateUrlFromSlug(clean);
  showSlugStatus(clean);
}

function showSlugStatus(slug) {
  const el = document.getElementById('slugStatus');
  if (!slug) { el.textContent = ''; return; }
  const isClean = /^[a-z0-9][a-z0-9-]*[a-z0-9]$|^[a-z0-9]$/.test(slug);
  el.textContent = isClean ? '‚úì slug-safe' : '‚ö† fix slug';
  el.style.color = isClean ? 'var(--success)' : 'var(--warning)';
}

function updateUrlFromSlug(slug) {
  if (slugUrlManual) return; // user typed URL manually, don't overwrite
  const baseInput = document.getElementById('targetUrl');
  const existing = baseInput.value;
  // Extract base domain from existing URL if present
  const domainMatch = existing.match(/^(https?:\/\/[^/]+)/);
  const base = domainMatch ? domainMatch[1] : 'https://example.com';
  baseInput.value = slug ? `${base}/${slug}/` : `${base}/`;
}

function getSlug() {
  const manualSlug = document.getElementById('pageSlug').value.trim();
  if (manualSlug) return manualSlug;
  const kw = document.getElementById('focusKeyword').value.trim();
  return kwToSlug(kw);
}

// ‚îÄ‚îÄ‚îÄ CONFIG SUMMARY ‚îÄ‚îÄ‚îÄ
function buildConfigSummary() {
  const kw = document.getElementById('focusKeyword').value.trim();
  const type = document.getElementById('pageType').selectedOptions[0].text;
  const site = document.getElementById('siteName').value || 'My Website';
  const tone = document.getElementById('tone').selectedOptions[0].text;
  const wc = parseInt(document.getElementById('wordCount').value);
  const slug = getSlug() || kw.toLowerCase().replace(/\s+/g, '-');
  const url = document.getElementById('targetUrl').value || `https://example.com/${slug}/`;

  document.getElementById('configSummary').innerHTML = `
    <div style="display:grid;grid-template-columns:140px 1fr;gap:4px 12px;font-size:13px;">
      <span style="color:var(--muted);">Focus keyword</span><span style="font-weight:500;">${kw}</span>
      <span style="color:var(--muted);">Secondary</span><span>${secKeywords.length ? secKeywords.join(', ') : '‚Äî'}</span>
      <span style="color:var(--muted);">Page type</span><span>${type}</span>
      <span style="color:var(--muted);">Slug</span><span style="font-family:var(--mono);font-size:12px;background:var(--chip-bg);padding:1px 6px;border-radius:4px;">${slug}</span>
      <span style="color:var(--muted);">Site name</span><span>${site}</span>
      <span style="color:var(--muted);">Tone</span><span>${tone}</span>
      <span style="color:var(--muted);">Word count</span><span>${wc.toLocaleString()}+ words</span>
      <span style="color:var(--muted);">Schema</span><span>${schemaTypes.join(', ')}</span>
      <span style="color:var(--muted);">URL</span><span style="word-break:break-all;font-family:var(--mono);font-size:11px;">${url}</span>
      ${(document.getElementById('pageBrandColors')?.value.trim()) ? `<span style="color:var(--muted);">Brand colors</span><span style="font-style:italic;">${document.getElementById('pageBrandColors').value.trim().slice(0,60)}${document.getElementById('pageBrandColors').value.trim().length > 60 ? '‚Ä¶' : ''}</span>` : ''}
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ
// Now calls YOUR backend at /api/generate ‚Äî API key stays on the server
async function generatePage() {
  const focusKw = document.getElementById('focusKeyword').value.trim();
  const pageType = document.getElementById('pageType').value;
  const siteName = document.getElementById('siteName').value || 'My Website';
  const pageTitle = document.getElementById('pageTitle').value.trim();
  const targetUrl = document.getElementById('targetUrl').value.trim() || `https://example.com/${focusKw.toLowerCase().replace(/\s+/g, '-')}/`;
  const tone = document.getElementById('tone').value;
  const wc = parseInt(document.getElementById('wordCount').value) || 1000;

  window._targetWordCount = wc;

  startLoading(focusKw);

  const prompt = buildPrompt(focusKw, secKeywords, pageType, siteName, targetUrl, tone, schemaTypes, pageTitle, wc, (document.getElementById('pageBrandColors')?.value.trim() || ''));

  try {
    // ‚úÖ Calls your backend ‚Äî API key never touches the browser
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, wordCount: wc }),
    });

    if (!res.ok) {
      let msg = `Server error ${res.status}`;
      try { const d = await res.json(); msg = d.error || msg; } catch(e) {}
      throw new Error(msg);
    }

    const data = await res.json();
    let html = data.html?.trim() || '';

    if (!html) throw new Error('Empty response from server.');

    html = cleanHTML(html);

    if (!html || html.length < 200) throw new Error('Could not extract content. Try again.');

    if (pageDiviMode) html = stripInlineStyles(html);
    else html = enforceCSSScoping(html);
    generatedHTML = html;
    stopLoading();
    renderResult(html, focusKw, targetUrl);
    showToast('success', pageDiviMode ? 'Page generated ‚Äî Divi CSS stripped!' : 'Page generated!');

  } catch(err) {
    stopLoading();
    showToast('error', err.message);
    console.error(err);
  }
}

function buildPrompt(focusKw, secKws, pageType, siteName, url, tone, schemas, pageTitle, wc, brandColors) {
  const slug = getSlug();
  const title = pageTitle || (focusKw + ' | ' + siteName);
  const secList = secKws.length ? secKws.join(', ') : 'none specified';
  const schemaList = schemas.join(', ');
  const brandColorInstruction = brandColors
    ? `BRAND COLORS ‚Äî read the following carefully and apply each instruction to the CSS:
"${brandColors}"
Rules for interpreting:
- If specific heading levels are mentioned (e.g. "H1: #1d4ed8, H2: #374151"), apply each color ONLY to that heading level
- If hex codes are given, use them exactly as provided
- If colors are described in words (e.g. "dark navy", "forest green"), choose the closest appropriate hex value
- If a URL is given, infer the brand colors from the domain or brand identity
- If "CTA" or "CTA box" is mentioned, apply that color as the CTA box background with auto-contrasting text (white or black)
- If only one color is given with no tag specified, apply it to all headings and derive a complementary CTA color
- If H1/H2/H3 are specified separately, give each its own color rule in the CSS ‚Äî do not group them
- Always ensure text contrast is accessible (WCAG AA minimum)`
    : `Use clean, professional default styling. Headings in #111111, CTA box in #2563eb with white text.`;

  const diviMode = typeof pageDiviMode !== 'undefined' && pageDiviMode;
  const scopeId = 'pf-' + slug.slice(0,6).replace(/[^a-z0-9]/g,'') + '-' + Math.random().toString(36).slice(2,6);
  const stylingInstruction = diviMode
    ? `STYLING ‚Äî DIVI MODE:
- DO NOT include any <style> blocks whatsoever
- DO NOT add inline style="" attributes on any element
- DO NOT include any <script> blocks for FAQ accordion
- Wrap ALL content in: <div id="${scopeId}" class="pf-content">...</div>
- Use class names: .wp-seo-faq, .wp-seo-cta, .wp-seo-intro, .wp-seo-section
- Divi theme builder controls all colors, fonts, spacing, layout
- CTA box: <div class="wp-seo-cta"><p>text here</p></div> ‚Äî no inline styles`
    : `STYLING ‚Äî SCOPED CSS (follow every rule exactly or WordPress will break):

STEP 1 ‚Äî Wrap ALL content in one outer div:
<div id="${scopeId}" class="pf-content">
  ...everything goes here...
</div>

CRITICAL: Do NOT write any <style> block before this wrapper div.
Do NOT add any <style> block with body{}, *{}, img{}, a{}, or any unscoped rules anywhere.
The ONLY <style> block allowed is one that uses exclusively #${scopeId} prefixed selectors.

STEP 2 ‚Äî Write a <style> block BEFORE that wrapper. Every selector MUST start with #${scopeId}:
CORRECT:   #${scopeId} h1 { color: #1d4ed8; }
CORRECT:   #${scopeId} .wp-seo-cta { background: #f59e0b; }
WRONG:     h1 { color: #1d4ed8; }  ‚Äî breaks WordPress theme
WRONG:     .wp-seo-cta { background: #f59e0b; }  ‚Äî leaks globally

ABSOLUTE BANS:
- NEVER target body, html, *, :root
- NEVER use !important
- NEVER write a selector without the #${scopeId} prefix

STEP 3 ‚Äî FIRST rule inside the style block MUST be this scoped reset to neutralise
any WordPress/Divi/theme global CSS bleeding into the content:
#${scopeId} {
  all: initial;
  display: block;
  box-sizing: border-box;
  max-width: 860px;
  margin: 0 auto;
  padding: 0 20px 40px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 1rem;
  line-height: 1.7;
  color: #333;
}
#${scopeId} * {
  box-sizing: border-box;
}
#${scopeId} h1, #${scopeId} h2, #${scopeId} h3,
#${scopeId} h4, #${scopeId} h5, #${scopeId} h6 {
  all: unset;
  display: block;
  font-weight: 700;
  line-height: 1.3;
  margin: 0.8em 0 0.4em;
}
#${scopeId} p {
  all: unset;
  display: block;
  margin: 0 0 1.2em;
  line-height: 1.7;
}
#${scopeId} a {
  all: unset;
  cursor: pointer;
  text-decoration: underline;
}
#${scopeId} img {
  all: unset;
  display: block;
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 1em 0;
}
#${scopeId} ul, #${scopeId} ol {
  all: unset;
  display: block;
  padding-left: 1.6em;
  margin: 0 0 1.2em;
}
#${scopeId} li {
  all: unset;
  display: list-item;
  margin-bottom: 0.4em;
}
#${scopeId} table {
  all: unset;
  display: table;
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1.5em;
}
#${scopeId} th, #${scopeId} td {
  all: unset;
  display: table-cell;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  text-align: left;
}

Then AFTER the reset, write ALL your heading sizes, brand colors, CTA box, FAQ styles etc ‚Äî all scoped to #${scopeId}

${brandColorInstruction}

MEDIA QUERIES: scope ALL selectors inside @media too:
@media (max-width:768px) { #${scopeId} h1 { font-size:1.5rem; } }`;

  return `You are an expert SEO content writer and WordPress developer. Generate WORDPRESS BODY CONTENT ONLY ‚Äî no full HTML page, no <html>, no <head>, no header, no nav, no footer.

INPUTS:
- Focus Keyword: "${focusKw}"
- Page Title: "${title}"
- Secondary Keywords: ${secList}
- Page Type: ${pageType}
- Site Name: ${siteName}
- Target URL: ${url}
- Tone: ${tone}
- Target Word Count: ${wc} words minimum (HARD REQUIREMENT)
- Schema Types: ${schemaList}

OUTPUT FORMAT ‚Äî WORDPRESS BODY ONLY:

SECTION 1 ‚Äî SEO META COMMENT (for SEO plugin reference):
<!-- SEO META
================================================================
TITLE TAG:
${title}

META DESCRIPTION:
[Write 130-155 character description with "${focusKw}" and a CTA]

CANONICAL URL:
${url}

FOCUS KEYWORD: ${focusKw}

og:title: ${title}
og:description: [same as META DESCRIPTION]
og:url: ${url}
og:type: article
og:image: https://placehold.co/1200x630?text=${slug}

twitter:card: summary_large_image
twitter:title: ${title}
twitter:description: [same as META DESCRIPTION]
twitter:image: https://placehold.co/1200x630?text=${slug}
================================================================ -->

SECTION 2 ‚Äî JSON-LD SCHEMA:
<script type="application/ld+json"> block with: ${schemaList}
Include FAQPage with 5+ real Q&As. Include BreadcrumbList (3 levels).

SECTION 3 ‚Äî PAGE BODY CONTENT:
- ONE <h1> with focus keyword "${focusKw}"
- 5+ <h2> subheadings using secondary keywords
- Multiple <h3> under h2s
- Keyword "${focusKw}" in first paragraph
- ${wc}+ words of real, detailed content (NO lorem ipsum)
- EVERY <img> must have alt="[descriptive alt text with keyword]" ‚Äî NEVER omit alt
- Use https://placehold.co/800x400?text=${slug} for main image
- Use https://placehold.co/600x300?text=Section for secondary images
- 3+ internal anchor links: <a href="${url}#section-id">text</a>
- FAQ section with 5+ Q&As
- DO NOT include header/nav/footer/breadcrumb UI/sidebar

${stylingInstruction}`;
}

// ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ
let loadTimer = null;
let stepChain = null;
const STEPS = [
  { id: 'ls1', pct: 10, label: 'Analyzing keyword strategy...', dur: 1800 },
  { id: 'ls2', pct: 30, label: 'Generating SEO content...', dur: 3500 },
  { id: 'ls3', pct: 60, label: 'Building schema markup...', dur: 2200 },
  { id: 'ls4', pct: 80, label: 'Applying SEO rules...', dur: 2000 },
  { id: 'ls5', pct: 95, label: 'Finalizing design...', dur: 1500 },
];

function startLoading(kw) {
  document.getElementById('loadingOverlay').classList.add('active');
  document.getElementById('generateBtn').disabled = true;
  if (kw) document.getElementById('loadingKw').textContent = `"${kw}"`;

  STEPS.forEach(s => {
    const el = document.getElementById(s.id);
    if (el) el.className = 'lstep';
  });

  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('loadingStep').textContent = 'Starting up...';

  const start = Date.now();
  loadTimer = setInterval(() => {
    const el = document.getElementById('loadingTimer');
    if (el) el.textContent = Math.floor((Date.now() - start) / 1000) + 's';
  }, 500);

  let i = 0;
  function run() {
    if (i >= STEPS.length) return;
    const s = STEPS[i];
    if (i > 0) {
      const prev = document.getElementById(STEPS[i-1].id);
      if (prev) prev.className = 'lstep done';
    }
    const el = document.getElementById(s.id);
    if (el) el.className = 'lstep active';
    document.getElementById('progressFill').style.width = s.pct + '%';
    document.getElementById('loadingStep').textContent = s.label;
    i++;
    stepChain = setTimeout(run, s.dur);
  }
  run();
}

function stopLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
  document.getElementById('generateBtn').disabled = false;
  clearInterval(loadTimer);
  clearTimeout(stepChain);
  document.getElementById('progressFill').style.width = '100%';
}

// ‚îÄ‚îÄ‚îÄ RENDER RESULT ‚îÄ‚îÄ‚îÄ
function renderResult(html, kw, url) {
  const shell = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>.pf-preview-wrap{padding:32px 40px;font-family:-apple-system,sans-serif;max-width:860px;margin:0 auto;}</style></head><body class="pf-preview-wrap">${html}</body></html>`;
  const blob = new Blob([shell], { type: 'text/html; charset=utf-8' });
  const blobUrl = URL.createObjectURL(blob);
  const frame = document.getElementById('previewFrame');
  if (frame._blobUrl) URL.revokeObjectURL(frame._blobUrl);
  frame._blobUrl = blobUrl;
  frame.src = blobUrl;
  document.getElementById('previewUrl').textContent = url;

  document.getElementById('codeBlock').textContent = html;
  document.getElementById('codeLines').textContent = html.split('\n').length + ' lines';

  const analysis = analyzeHTML(html, kw);
  renderSEOScore(analysis);

  document.getElementById('resultSection').classList.add('visible');

  setTimeout(() => {
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 200);
}

// ‚îÄ‚îÄ‚îÄ SEO ANALYSIS ‚îÄ‚îÄ‚îÄ
function analyzeHTML(html, kw) {
  const kwLower = kw.toLowerCase();
  const h1s = [...html.matchAll(/<h1[^>]*>([\s\S]*?)<\/h1>/gi)];
  const h2s = [...html.matchAll(/<h2[^>]*>/gi)];
  const imgs = [...html.matchAll(/<img[^>]+>/gi)];
  const altMissing = imgs.filter(m => !(/alt\s*=/i.test(m[0])) || /alt\s*=\s*["']\s*["']/i.test(m[0])).length;

  const bodyText = html.replace(/<[^>]+>/g, ' ').toLowerCase();
  const firstPara = (html.match(/<p[^>]*>([\s\S]*?)<\/p>/i) || ['',''])[1].replace(/<[^>]+>/g,'').toLowerCase();

  const titleMatch = html.match(/TITLE TAG:\s*\n(.*)/i);
  const titleLen = titleMatch ? titleMatch[1].trim().length : 0;

  const metaMatch = html.match(/META DESCRIPTION:\s*\n([\s\S]*?)(?=\n\n|\nCANONICAL)/i);
  const metaText = metaMatch ? metaMatch[1].trim() : '';
  const metaLen = metaText.length;

  const headings = [...html.matchAll(/<(h[1-6])[^>]*>/gi)].map(m => parseInt(m[1].slice(1)));
  let flowOk = true;
  for (let i = 1; i < headings.length; i++) {
    if (headings[i] - headings[i-1] > 1) { flowOk = false; break; }
  }

  const faqItems = [...html.matchAll(/<(dt|\.faq-q|question)[^>]*>/gi)].length +
    [...html.matchAll(/class="[^"]*faq[^"]*"/gi)].length / 2;

  const secKwUsed = secKeywords.every(sk => bodyText.includes(sk.toLowerCase()));

  return {
    titleLen,
    metaLen,
    metaHasKw: metaText.toLowerCase().includes(kwLower),
    h1Count: h1s.length,
    h1HasKw: h1s.some(m => m[1].toLowerCase().includes(kwLower)),
    h2Count: h2s.length,
    firstParaHasKw: firstPara.includes(kwLower),
    hasCanonical: /CANONICAL URL:/i.test(html),
    hasSchema: /<script[^>]*application\/ld\+json/i.test(html),
    hasFaqSchema: /FAQPage/i.test(html),
    hasBreadcrumb: /BreadcrumbList/i.test(html),
    imgsMissingAlt: altMissing,
    hasOg: /og:title/i.test(html),
    hasTwitter: /twitter:card/i.test(html),
    wordCount: bodyText.split(/\s+/).length,
    internalLinks: (html.match(/href="[^"]*#[^"]+"/gi) || []).length,
    faqCount: Math.max(faqItems, (html.match(/<\/summary>|class="faq-answer"/gi) || []).length),
    headingFlowOk: flowOk,
    secKwUsed: secKeywords.length === 0 || secKwUsed,
    hasStyle: /<style/i.test(html),
  };
}

function renderSEOScore(d) {
  let pass = 0;
  const list = document.getElementById('rulesList');
  list.innerHTML = SEO_RULES.map(rule => {
    const ok = rule.check(d);
    if (ok) pass++;
    return `<div class="rule-row ${ok ? 'pass' : 'fail'}">
      <div class="rule-dot"></div>
      <span>${rule.label}</span>
      <span style="margin-left:auto;font-family:var(--mono);font-size:10px;">${ok ? '‚úì' : '‚úó'}</span>
    </div>`;
  }).join('');

  const score = Math.round((pass / SEO_RULES.length) * 100);
  const circle = document.getElementById('scoreCircle');
  const circ = 175.9;
  circle.style.strokeDashoffset = circ - (circ * score / 100);

  let color = '#dc2626';
  if (score >= 80) color = '#16a34a';
  else if (score >= 60) color = '#d97706';
  else if (score >= 40) color = '#2563eb';
  circle.style.stroke = color;

  document.getElementById('scoreNum').textContent = score;
  document.getElementById('scoreLabel').textContent = score >= 80 ? 'Excellent' : score >= 60 ? 'Good' : score >= 40 ? 'Needs Work' : 'Poor';
  document.getElementById('scoreSubLabel').textContent = `${pass} of ${SEO_RULES.length} rules passing`;
  document.getElementById('seoScoreBadge').textContent = `SEO ${score}/100`;
}

function renderRulesList() {
  const list = document.getElementById('rulesList');
  list.innerHTML = SEO_RULES.map(rule => `
    <div class="rule-row" id="rule-${rule.id}">
      <div class="rule-dot"></div>
      <span>${rule.label}</span>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ RESULT TABS ‚îÄ‚îÄ‚îÄ
function switchRTab(id, btn) {
  document.querySelectorAll('.rtab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rtab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('rp-' + id).classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ DOWNLOAD / COPY ‚îÄ‚îÄ‚îÄ
function downloadPage() {
  if (!generatedHTML) return;
  const kw = document.getElementById('focusKeyword').value.trim().toLowerCase().replace(/\s+/g,'-') || 'page';
  const blob = new Blob([generatedHTML], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${kw}-seo-page.html`;
  a.click();
  showToast('success', 'Downloaded!');
}

function copyCode() {
  if (!generatedHTML) return;
  navigator.clipboard.writeText(generatedHTML).then(() => {
    showToast('success', 'Copied to clipboard!');
  });
}

function openInNew() {
  if (!generatedHTML) return;
  const blob = new Blob([generatedHTML], { type: 'text/html' });
  window.open(URL.createObjectURL(blob), '_blank');
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
function showToast(type, msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SILO BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentMode = 'page';
let currentSiloStep = 1;
let pillarSecKws = [];
let crossSilos = [];
let childPosts = [];
let siloBlueprint = '';

// ‚îÄ‚îÄ‚îÄ MODE SWITCHER ‚îÄ‚îÄ‚îÄ
function switchMode(mode) {
  currentMode = mode;
  const pageBtn = document.getElementById('modePageBtn');
  const siloBtn = document.getElementById('modeSiloBtn');
  const pageSection = document.getElementById('pageBuilderSection');
  const siloSection = document.getElementById('siloBuilderSection');
  const heroTitle = document.getElementById('heroTitle');
  const heroSub = document.getElementById('heroSub');

  if (mode === 'silo') {
    pageBtn.style.background = 'transparent';
    pageBtn.style.color = 'var(--muted)';
    siloBtn.style.background = '#111';
    siloBtn.style.color = '#fff';
    pageSection.style.display = 'none';
    siloSection.style.display = 'block';
    heroTitle.innerHTML = 'Silo structure &amp;<br>interlinking blueprint.';
    heroSub.textContent = 'Plan your full content silo ‚Äî pillar page, child posts, slug-safe URLs, and a complete internal linking strategy.';
  } else {
    pageBtn.style.background = '#111';
    pageBtn.style.color = '#fff';
    siloBtn.style.background = 'transparent';
    siloBtn.style.color = 'var(--muted)';
    pageSection.style.display = 'block';
    siloSection.style.display = 'none';
    heroTitle.innerHTML = 'SEO-optimized pages,<br>in seconds.';
    heroSub.textContent = 'Generate WordPress-ready HTML with full SEO optimization ‚Äî schema markup, meta tags, and 20-point SEO scoring.';
  }
}

// ‚îÄ‚îÄ‚îÄ SILO STEP MANAGEMENT ‚îÄ‚îÄ‚îÄ
function goToSiloStep(n) {
  document.querySelectorAll('#siloBuilderSection .step').forEach((el, i) => {
    const num = i + 1;
    el.classList.remove('active', 'done');
    if (num < n) el.classList.add('done');
    if (num === n) el.classList.add('active');
  });
  currentSiloStep = n;
  if (n === 3) buildSiloConfigSummary();
}

function editSiloStep(n) {
  if (currentSiloStep > n) goToSiloStep(n);
}

// ‚îÄ‚îÄ‚îÄ SILO STEP 1 ‚îÄ‚îÄ‚îÄ
function completeSiloStep1() {
  const title = document.getElementById('pillarTitle').value.trim();
  const slug = document.getElementById('pillarSlug').value.trim();
  if (!title) { showToast('error', 'Please enter a Pillar Title'); return; }
  if (!slug)  { showToast('error', 'Please enter a Pillar Slug');  return; }
  document.getElementById('siloSummary1').textContent = `"${title}" ‚Üí /${slug}/ ¬∑ ${getSiloWordCount().toLocaleString()} words/page`;
  goToSiloStep(2);
  if (childPosts.length === 0) addChildPost();
}

// ‚îÄ‚îÄ‚îÄ PILLAR SLUG HELPERS ‚îÄ‚îÄ‚îÄ
function onPillarSlugInput() {
  // just live-sanitize display
}
function sanitizePillarSlug() {
  const el = document.getElementById('pillarSlug');
  el.value = toSlug(el.value);
}

// ‚îÄ‚îÄ‚îÄ SILO STEP 2: CHILD POSTS ‚îÄ‚îÄ‚îÄ
function addChildPost() {
  const idx = childPosts.length;
  childPosts.push({ title: '', slug: '', primaryKw: '', secondaryKws: [] });
  renderChildPosts();
  // focus the new title field
  setTimeout(() => {
    const el = document.getElementById(`cp_title_${idx}`);
    if (el) el.focus();
  }, 50);
}

function removeChildPost(idx) {
  childPosts.splice(idx, 1);
  renderChildPosts();
}

function renderChildPosts() {
  const container = document.getElementById('childPostsList');
  if (childPosts.length === 0) {
    container.innerHTML = '';
    return;
  }
  container.innerHTML = childPosts.map((cp, i) => `
    <div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <span style="font-size:12px;font-weight:600;color:var(--muted);font-family:var(--mono);">POST ${i+1}</span>
        <button onclick="removeChildPost(${i})" style="font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer;padding:2px 6px;border-radius:4px;transition:color 0.1s;" onmouseover="this.style.color='var(--error)'" onmouseout="this.style.color='var(--muted)'">‚úï Remove</button>
      </div>
      <div class="field">
        <label style="font-size:12px;">Post Title</label>
        <input type="text" id="cp_title_${i}" value="${escHtml(cp.title)}" placeholder="e.g. Best Companion Plants for Tomatoes"
          oninput="updateChildPost(${i},'title',this.value);autoFillChildSlug(${i})">
      </div>
      <div class="field">
        <label style="font-size:12px;">Post Slug <span class="label-hint">‚Äî edit freely, used exactly as given</span></label>
        <div style="display:flex;align-items:center;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--surface);" id="cpSlugWrap_${i}">
          <span style="padding:8px 8px 8px 10px;font-size:12px;color:var(--muted);font-family:var(--mono);white-space:nowrap;border-right:1px solid var(--border);background:var(--bg);">/${document.getElementById('pillarSlug')?.value||'pillar'}/</span>
          <input type="text" id="cp_slug_${i}" value="${escHtml(cp.slug)}" placeholder="companion-plants-tomatoes"
            style="border:none;border-radius:0;box-shadow:none;flex:1;font-family:var(--mono);font-size:12px;padding:8px 10px;"
            oninput="updateChildPost(${i},'slug',this.value)"
            onblur="sanitizeChildSlug(${i})">
        </div>
      </div>
      <div class="two-col">
        <div class="field">
          <label style="font-size:12px;">Primary Keyword</label>
          <input type="text" id="cp_pkw_${i}" value="${escHtml(cp.primaryKw)}" placeholder="companion planting tomatoes"
            oninput="updateChildPost(${i},'primaryKw',this.value)">
        </div>
        <div class="field">
          <label style="font-size:12px;">Secondary Keywords <span class="label-hint">‚Äî comma separated</span></label>
          <input type="text" id="cp_skw_${i}" value="${cp.secondaryKws.join(', ')}" placeholder="tomato companions, garden planting"
            oninput="updateChildPost(${i},'secondaryKwsRaw',this.value)">
        </div>
      </div>
    </div>
  `).join('');
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function updateChildPost(idx, field, val) {
  if (!childPosts[idx]) return;
  if (field === 'secondaryKwsRaw') {
    childPosts[idx].secondaryKws = val.split(',').map(s=>s.trim()).filter(Boolean);
  } else {
    childPosts[idx][field] = val;
  }
}

function autoFillChildSlug(idx) {
  const titleVal = document.getElementById(`cp_title_${idx}`).value;
  const slugEl = document.getElementById(`cp_slug_${idx}`);
  // Only auto-fill if slug is still empty
  if (!slugEl.value) {
    slugEl.value = toSlug(titleVal);
    childPosts[idx].slug = slugEl.value;
  }
}

function sanitizeChildSlug(idx) {
  const el = document.getElementById(`cp_slug_${idx}`);
  if (!el) return;
  const clean = toSlug(el.value);
  el.value = clean;
  childPosts[idx].slug = clean;
}

function completeSiloStep2() {
  // Read current field values into childPosts state
  childPosts.forEach((cp, i) => {
    const t = document.getElementById(`cp_title_${i}`);
    const s = document.getElementById(`cp_slug_${i}`);
    const p = document.getElementById(`cp_pkw_${i}`);
    const sk = document.getElementById(`cp_skw_${i}`);
    if (t) cp.title = t.value.trim();
    if (s) cp.slug = toSlug(s.value.trim());
    if (p) cp.primaryKw = p.value.trim();
    if (sk) cp.secondaryKws = sk.value.split(',').map(x=>x.trim()).filter(Boolean);
  });

  const valid = childPosts.filter(cp => cp.title && cp.slug);
  if (valid.length === 0) { showToast('error', 'Add at least one child post with a title and slug'); return; }

  document.getElementById('siloSummary2').textContent = `${valid.length} post${valid.length>1?'s':''}: ${valid.map(cp=>cp.slug).join(', ')}`;
  goToSiloStep(3);
}

// ‚îÄ‚îÄ‚îÄ SILO CONFIG SUMMARY ‚îÄ‚îÄ‚îÄ
function buildSiloConfigSummary() {
  const pillarTitle = document.getElementById('pillarTitle').value.trim();
  const pillarSlug  = document.getElementById('pillarSlug').value.trim();
  const pillarPKw   = document.getElementById('pillarPrimaryKw').value.trim();
  const siteUrl     = document.getElementById('siloSiteUrl').value.trim() || '/';
  const validPosts  = childPosts.filter(cp => cp.title && cp.slug);

  const rows = validPosts.map(cp =>
    `<span style="color:var(--muted);">  ‚îî post</span><span style="font-family:var(--mono);font-size:11px;">${cp.slug} ‚Äî "${cp.title}"</span>`
  ).join('');

  document.getElementById('siloConfigSummary').innerHTML = `
    <div style="display:grid;grid-template-columns:140px 1fr;gap:4px 12px;font-size:13px;">
      <span style="color:var(--muted);">Pillar</span><span style="font-weight:500;">${pillarTitle}</span>
      <span style="color:var(--muted);">Pillar slug</span><span style="font-family:var(--mono);font-size:12px;background:var(--chip-bg);padding:1px 6px;border-radius:4px;">/${pillarSlug}/</span>
      <span style="color:var(--muted);">Primary keyword</span><span>${pillarPKw||'‚Äî'}</span>
      <span style="color:var(--muted);">Secondary kws</span><span>${pillarSecKws.length ? pillarSecKws.join(', ') : '‚Äî'}</span>
      <span style="color:var(--muted);">Words per page</span><span>${getSiloWordCount().toLocaleString()} words</span>
      ${document.getElementById('siloBrandColors')?.value.trim() ? `<span style="color:var(--muted);">Brand colors</span><span style="font-style:italic;color:var(--text);">${document.getElementById('siloBrandColors').value.trim().slice(0,60)}${document.getElementById('siloBrandColors').value.trim().length > 60 ? '‚Ä¶' : ''}</span>` : ''}
      ${siloDiviMode ? `<span style="color:var(--muted);">Theme CSS</span><span style="font-weight:600;">Divi mode ‚Äî inline styles stripped</span>` : ''}
      <span style="color:var(--muted);">Site URL</span><span style="font-family:var(--mono);font-size:11px;">${siteUrl}</span>
      <span style="color:var(--muted);">Child posts</span><span>${validPosts.length}</span>
      ${rows}
      ${crossSilos.length ? `<span style="color:var(--muted);">Cross-silos</span><span>${crossSilos.join(', ')}</span>` : ''}
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ PILLAR SECONDARY KW TAGS ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  // pillar secondary kw tags
  const pInput = document.getElementById('pillarKwInput');
  if (pInput) {
    pInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const val = pInput.value.replace(/,$/, '').trim();
        if (val && !pillarSecKws.includes(val)) {
          pillarSecKws.push(val);
          renderPillarKwTags();
        }
        pInput.value = '';
      }
      if (e.key === 'Backspace' && !pInput.value && pillarSecKws.length) {
        pillarSecKws.pop();
        renderPillarKwTags();
      }
    });
  }

  // cross-silo tags
  const csInput = document.getElementById('crossSiloInput');
  if (csInput) {
    csInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const val = csInput.value.replace(/,$/, '').trim();
        if (val && !crossSilos.includes(val)) {
          crossSilos.push(val);
          renderCrossSiloTags();
        }
        csInput.value = '';
      }
      if (e.key === 'Backspace' && !csInput.value && crossSilos.length) {
        crossSilos.pop();
        renderCrossSiloTags();
      }
    });
  }
});

function renderPillarKwTags() {
  const container = document.getElementById('pillarKwTags');
  const input = document.getElementById('pillarKwInput');
  container.innerHTML = '';
  pillarSecKws.forEach((kw, i) => {
    const tag = document.createElement('span');
    tag.className = 'kw-tag';
    tag.innerHTML = `${kw}<span class="kw-tag-remove" onclick="removePillarKw(${i})">√ó</span>`;
    container.appendChild(tag);
  });
  container.appendChild(input);
}

function removePillarKw(i) {
  pillarSecKws.splice(i, 1);
  renderPillarKwTags();
}

function renderCrossSiloTags() {
  const container = document.getElementById('crossSiloTags');
  const input = document.getElementById('crossSiloInput');
  container.innerHTML = '';
  crossSilos.forEach((s, i) => {
    const tag = document.createElement('span');
    tag.className = 'kw-tag';
    tag.innerHTML = `${s}<span class="kw-tag-remove" onclick="removeCrossSilo(${i})">√ó</span>`;
    container.appendChild(tag);
  });
  container.appendChild(input);
}

function removeCrossSilo(i) {
  crossSilos.splice(i, 1);
  renderCrossSiloTags();
}

// ‚îÄ‚îÄ‚îÄ SHARED SLUG UTILITY ‚îÄ‚îÄ‚îÄ
function toSlug(str) {
  return String(str).toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}

// ‚îÄ‚îÄ‚îÄ SILO WORD COUNT ‚îÄ‚îÄ‚îÄ
function updateSiloWC() {
  const v = parseInt(document.getElementById('siloWordCount').value);
  document.getElementById('siloWcDisplay').textContent = v.toLocaleString() + ' words';
  const hint = v < 700  ? 'Lean pages ‚Äî fast to generate, lighter on content depth.'
    : v < 1200 ? 'Good for focused child posts with a clear single topic.'
    : v < 2000 ? 'Good balance of depth and generation speed for most silo pages.'
    : v < 3000 ? 'Comprehensive pages ‚Äî ideal for pillar content and detailed guides.'
    : 'Deep-dive content ‚Äî slower to generate but maximum topical authority.';
  document.getElementById('siloWcHint').textContent = hint;
}

function getSiloWordCount() {
  const el = document.getElementById('siloWordCount');
  return el ? parseInt(el.value) || 1500 : 1500;
}

// ‚îÄ‚îÄ‚îÄ DIVI MODE ‚îÄ‚îÄ‚îÄ
let pageDiviMode = false;
let siloDiviMode = false;

function toggleDivi(mode) {
  if (mode === 'page') {
    pageDiviMode = !pageDiviMode;
    document.getElementById('pageDiviTrack').classList.toggle('on', pageDiviMode);
    document.getElementById('pageBrandColorsWrap').style.opacity = pageDiviMode ? '0.4' : '1';
    document.getElementById('pageBrandColorsWrap').style.pointerEvents = pageDiviMode ? 'none' : '';
    document.getElementById('pageDiviHint').textContent = pageDiviMode
      ? '‚úì On ‚Äî all inline <style> blocks will be stripped. Divi controls the design.'
      : 'Off ‚Äî generated page includes its own scoped CSS.';
  } else {
    siloDiviMode = !siloDiviMode;
    document.getElementById('siloDiviTrack').classList.toggle('on', siloDiviMode);
    document.getElementById('siloBrandColorsWrap').style.opacity = siloDiviMode ? '0.4' : '1';
    document.getElementById('siloBrandColorsWrap').style.pointerEvents = siloDiviMode ? 'none' : '';
    document.getElementById('siloDiviHint').textContent = siloDiviMode
      ? '‚úì On ‚Äî all inline <style> blocks will be stripped from every page. Divi controls the design.'
      : 'Off ‚Äî generated pages include their own scoped CSS.';
  }
}

// Strip all <style> blocks and inline style="" attributes from generated HTML
// ‚îÄ‚îÄ‚îÄ CLEAN HTML ‚Äî strips all head-level elements from generated content ‚îÄ‚îÄ‚îÄ
function cleanHTML(html) {
  // 1. Strip markdown code fences
  const fence = html.match(/^```(?:html)?\s*\n?([\s\S]*?)```\s*$/i);
  if (fence) html = fence[1].trim();

  // 2. If full HTML page returned, extract just the body
  if (html.toLowerCase().includes('<!doctype') || /<html[\s>]/i.test(html)) {
    const body = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
    if (body) {
      html = body[1].trim();
    } else {
      // Fallback: strip all head-level wrapper tags
      html = html
        .replace(/<!doctype[^>]*>/gi, '')
        .replace(/<html[^>]*>/gi, '')
        .replace(/<\/html>/gi, '')
        .replace(/<head[\s\S]*?<\/head>/gi, '')
        .replace(/<body[^>]*>/gi, '')
        .replace(/<\/body>/gi, '')
        .trim();
    }
  }

  // 3. Strip any remaining head-only elements that shouldn't be in body content
  html = html
    .replace(/<meta[^>]*>/gi, '')
    .replace(/<link[^>]*>/gi, '')
    .replace(/<title[^>]*>[\s\S]*?<\/title>/gi, '')
    .replace(/<base[^>]*>/gi, '')
    .trim();

  return html;
}

function stripInlineStyles(html) {
  html = html.replace(/<style[\s\S]*?<\/style>/gi, '');
  html = html.replace(/\s+style\s*=\s*["'][^"']*["']/gi, '');
  html = html.replace(/\s+style\s*=\s*[""]["']/gi, '');
  return html.trim();
}

// Post-processor: enforce CSS scoping ‚Äî re-prefix any rules missing the scope ID
function enforceCSSScoping(html) {
  // Step 1: remove any <style> block that contains unscoped global rules
  // (body{}, *{}, img{}, a{} etc.) ‚Äî these are rogue shell styles Claude sometimes adds
  html = html.replace(/<style>([\s\S]*?)<\/style>/gi, (fullMatch, css) => {
    // Count how many rules are globally unscoped vs scoped to a #pf- id
    const rules = css.match(/[^{}]+\{[^{}]*\}/g) || [];
    const unscopedGlobals = rules.filter(r => {
      const sel = r.split('{')[0].trim();
      return /^(body|html|\*|img|a|p|h[1-6]|ul|ol|li)(\s*[,{]|$)/.test(sel) && !sel.includes('#pf-');
    });
    // If more than half the rules are unscoped globals, this is a rogue shell block ‚Äî strip it
    if (unscopedGlobals.length > 0 && unscopedGlobals.length >= rules.length * 0.4) {
      return '';
    }
    return fullMatch;
  });

  // Step 2: find scope ID and prefix any remaining unscoped selectors
  const scopeMatch = html.match(/id="(pf-[a-z0-9-]+)"/);
  if (!scopeMatch) return html;
  const sid = scopeMatch[1];

  return html.replace(/<style>([\s\S]*?)<\/style>/gi, (_full, css) => {
    const scoped = css.replace(/([^{}]+)\{/g, (_m, selector) => {
      if (/^\s*@/.test(selector.trim())) return _m;
      if (selector.includes('#' + sid)) return _m;
      const fixed = selector.split(',').map(s => {
        s = s.trim();
        if (!s || /^\s*\/\*/.test(s)) return s;
        if (/^(html|body|\*|:root)(\s|$)/.test(s)) return '#' + sid;
        return '#' + sid + ' ' + s;
      }).join(', ');
      return fixed + ' {';
    });
    return '<style>' + scoped + '</style>';
  });
}
async function generateSilo() {
  const pillarTitle = document.getElementById('pillarTitle').value.trim();
  const pillarSlug  = document.getElementById('pillarSlug').value.trim();
  const pillarPKw   = document.getElementById('pillarPrimaryKw').value.trim();
  const siteUrl     = document.getElementById('siloSiteUrl').value.trim();
  const validPosts  = childPosts.filter(cp => cp.title && cp.slug);

  if (!pillarTitle || !pillarSlug) { showToast('error', 'Complete pillar details first'); return; }
  if (validPosts.length === 0) { showToast('error', 'Add at least one child post'); return; }

  document.getElementById('generateSiloBtn').disabled = true;
  document.getElementById('generateSiloBtn').textContent = '‚è≥ Generating...';

  const prompt = buildSiloPrompt(pillarTitle, pillarSlug, pillarPKw, pillarSecKws, validPosts, siteUrl, crossSilos);

  try {
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, wordCount: 3000 }),
    });

    if (!res.ok) {
      let msg = `Server error ${res.status}`;
      try { const d = await res.json(); msg = d.error || msg; } catch(e) {}
      throw new Error(msg);
    }

    const data = await res.json();
    const text = (data.html || data.text || data.content || '').trim();
    if (!text) throw new Error('Empty response from server.');

    siloBlueprint = text;
    document.getElementById('siloBlueprintOutput').textContent = text;

    // Show result section ‚Äî use inline style so it can never be toggled away
    const resultEl = document.getElementById('siloResultSection');
    resultEl.classList.add('visible');
    resultEl.style.display = 'block';

    // Reset build panel state in case this is a re-generate
    document.getElementById('buildStatusPanel').style.display = 'none';
    document.getElementById('buildPagesBtn').disabled = false;
    document.getElementById('buildPagesBtn').textContent = '‚ö° Build All Pages';
    if (!siloZip) document.getElementById('downloadZipBtn').style.display = 'none';

    setTimeout(() => {
      resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
    showToast('success', 'Blueprint generated!');

  } catch(err) {
    showToast('error', err.message);
    console.error(err);
  } finally {
    document.getElementById('generateSiloBtn').disabled = false;
    document.getElementById('generateSiloBtn').textContent = 'üèó Generate Silo Blueprint';
  }
}

// ‚îÄ‚îÄ‚îÄ SILO PROMPT BUILDER ‚îÄ‚îÄ‚îÄ
function buildSiloPrompt(pillarTitle, pillarSlug, pillarPKw, pillarSecKws, posts, siteUrl, crossSilos) {
  const secKwStr = pillarSecKws.length ? pillarSecKws.join(', ') : 'none specified';
  const siteStr  = siteUrl || 'none provided';

  const postsBlock = posts.map((cp, i) => {
    const skStr = cp.secondaryKws && cp.secondaryKws.length ? cp.secondaryKws.join(', ') : 'none specified';
    return `- Post Title: ${cp.title}
  Post Slug: ${cp.slug}
  Primary Keyword: ${cp.primaryKw || 'not specified'}
  Secondary Keywords: ${skStr}`;
  }).join('\n\n');

  const crossStr = crossSilos.length
    ? `Existing related silos to cross-link: ${crossSilos.join(', ')}`
    : 'No existing cross-silos specified.';

  return `You are a senior SEO strategist and content architect.

INPUTS CONFIRMED ‚Äî interpret these exactly as given, do not alter any slugs:

SILO PILLAR
- Pillar Title: ${pillarTitle}
- Pillar Slug: ${pillarSlug}
- Primary Keyword: ${pillarPKw || 'not specified'}
- Secondary Keywords: ${secKwStr}

CHILD POSTS LIST
${postsBlock}

OPTIONAL
- Site URL: ${siteStr}
- ${crossStr}

HARD RULES
- Use the provided slugs EXACTLY as given. Do not rewrite, pluralize, change capitalization, or alter hyphens.
- Build a silo where every child post links back to the pillar using a consistent contextual anchor.
- The pillar must link out to every child post in a structured section.
- Add lateral links between child posts only when the topic relationship is strong and natural ‚Äî do not force it.
- Avoid orphan pages ‚Äî every page must have at least 1 link to parent pillar and 1 link from the pillar to it.
- Keep anchors varied but accurate. Avoid repeating the exact same anchor text everywhere.

First, restate the inputs you received so the user can confirm titles and slugs were interpreted correctly.

Then produce ALL of the following sections in this exact order:

A. URL MAP
Show the full URL structure using the provided slugs.
Format:
  Pillar: /pillar-slug/
  Child: /pillar-slug/post-slug/
If a site URL was provided, show full URLs.

B. NAVIGATION AND SILO RELATIONSHIPS
Describe the intended hierarchy in plain language.
Include a short note on breadcrumbs and how users move pillar ‚Üí post ‚Üí pillar.

C. PILLAR PAGE BLUEPRINT
- SEO title tag: 3 variations
- Meta description: 2 variations
- H1
- H2/H3 outline with notes on what each section covers
- "In This Silo" section listing all child posts with:
  - Link URL
  - Recommended anchor text
  - One sentence teaser
- FAQ block: 6‚Äì10 FAQs that support the pillar and naturally reference child posts
- Internal link placements: for each child post, list every placement on the pillar with recommended anchor text

D. CHILD POST BLUEPRINTS
For each child post:
- SEO title tag: 2 variations
- Meta description: 1 variation
- H1
- H2/H3 outline
- Mandatory internal links:
  - Link back to pillar (exact URL, 2 anchor options, best placement)
  - 1‚Äì3 lateral links to sibling posts only if strongly relevant (URL, why relevant, anchor suggestions)
- CTA suggestion (simple, non-spammy)

E. INTERLINKING STRATEGY TABLE
Columns: From Page | To Page | Link Type (parent/child/lateral) | Recommended Anchor | Placement Location

F. BUILD CHECKLIST
Bullet list of implementation steps including:
- Add pillar hub section
- Add breadcrumb logic
- Ensure each child includes parent link
- Add suggested lateral links only where relevant
- Add FAQ schema recommendation if appropriate`;
}

// ‚îÄ‚îÄ‚îÄ SILO COPY / DOWNLOAD BLUEPRINT ‚îÄ‚îÄ‚îÄ
function copySiloBlueprint() {
  if (!siloBlueprint) return;
  navigator.clipboard.writeText(siloBlueprint).then(() => showToast('success', 'Blueprint copied!'));
}

function downloadSiloBlueprint() {
  if (!siloBlueprint) return;
  const slug = document.getElementById('pillarSlug').value.trim() || 'silo';
  const blob = new Blob([siloBlueprint], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${slug}-silo-blueprint.txt`;
  a.click();
  showToast('success', 'Downloaded!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD ALL SILO PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let siloZip = null;
let builtPages = [];
let isBuilding = false;

async function buildSiloPages() {
  if (isBuilding) return;
  isBuilding = true;
  const pillarTitle = document.getElementById('pillarTitle').value.trim();
  const pillarSlug  = document.getElementById('pillarSlug').value.trim();
  const pillarPKw   = document.getElementById('pillarPrimaryKw').value.trim();
  const siteUrl     = (document.getElementById('siloSiteUrl').value.trim() || 'https://example.com').replace(/\/$/, '');
  const validPosts  = childPosts.filter(cp => cp.title && cp.slug);
  const tone        = 'professional';
  const wc          = getSiloWordCount();

  if (!pillarTitle || !pillarSlug) { isBuilding = false; showToast('error', 'Missing pillar details'); return; }
  if (validPosts.length === 0)     { isBuilding = false; showToast('error', 'No child posts to build'); return; }

  // Build page queue: pillar first, then children
  const queue = [
    {
      label: pillarTitle,
      slug: pillarSlug,
      url: `${siteUrl}/${pillarSlug}/`,
      focusKw: pillarPKw || pillarTitle,
      secKws: [...pillarSecKws],
      pageType: 'pillar',
      isPillar: true,
      internalLinks: validPosts.map(cp => ({
        text: cp.title,
        url: `${siteUrl}/${pillarSlug}/${cp.slug}/`
      }))
    },
    ...validPosts.map(cp => ({
      label: cp.title,
      slug: cp.slug,
      url: `${siteUrl}/${pillarSlug}/${cp.slug}/`,
      focusKw: cp.primaryKw || cp.title,
      secKws: cp.secondaryKws || [],
      pageType: 'blog',
      isPillar: false,
      internalLinks: [
        { text: pillarTitle, url: `${siteUrl}/${pillarSlug}/` },
        ...validPosts
          .filter(other => other.slug !== cp.slug)
          .slice(0, 2)
          .map(other => ({ text: other.title, url: `${siteUrl}/${pillarSlug}/${other.slug}/` }))
      ]
    }))
  ];

  const total = queue.length;
  builtPages = [];
  siloZip = null;

  // Show status panel, hide zip button
  document.getElementById('buildStatusPanel').style.display = 'block';
  document.getElementById('buildPagesBtn').disabled = true;
  document.getElementById('buildPagesBtn').textContent = '‚è≥ Building...';
  document.getElementById('downloadZipBtn').style.display = 'none';
  document.getElementById('buildStatusTitle').textContent = `Building ${total} page${total > 1 ? 's' : ''}...`;
  document.getElementById('buildStatusCount').textContent = `0 / ${total}`;
  document.getElementById('buildProgressFill').style.width = '0%';
  document.getElementById('buildProgressFill').style.background = '#111';

  // Scroll status panel into view
  setTimeout(() => {
    document.getElementById('buildStatusPanel').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);

  // Render all rows as pending
  document.getElementById('buildPageRows').innerHTML = queue.map((pg, i) =>
    buildStatusRow(i, pg.label, pg.isPillar ? 'üìå Pillar' : `üìÑ Post ${i}`, 'pending', 'waiting...')
  ).join('');

  let doneCount = 0;

  for (let i = 0; i < queue.length; i++) {
    const pg = queue[i];
    setRowState(i, 'active', 'generating...');

    try {
      const prompt = buildSiloPagePrompt(
        pg.focusKw, pg.secKws, pg.pageType,
        pillarTitle, pg.url, tone,
        ['Article', 'FAQPage', 'BreadcrumbList'],
        pg.label, wc, pg.internalLinks,
        pillarSlug, pg.isPillar,
        document.getElementById('siloBrandColors')?.value.trim() || ''
      );

      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, wordCount: wc }),
      });

      if (!res.ok) {
        let msg = `Server error ${res.status}`;
        try { const d = await res.json(); msg = d.error || msg; } catch(e) {}
        throw new Error(msg);
      }

      const data = await res.json();
      let html = (data.html || data.text || data.content || '').trim();
      if (!html) throw new Error('Empty response');

      html = cleanHTML(html);

      if (siloDiviMode) html = stripInlineStyles(html);
      else html = enforceCSSScoping(html);
      const wordCount = html.replace(/<[^>]+>/g,' ').split(/\s+/).filter(Boolean).length;
      const fullPage = wrapSiloPageShell(pg.label, pg.url, html);
      builtPages.push({ filename: pg.slug + '.html', content: fullPage, label: pg.label });
      doneCount++;
      setRowState(i, 'done', `${wordCount.toLocaleString()} words`);

    } catch(err) {
      doneCount++;
      setRowState(i, 'error', err.message.slice(0, 30));
      console.error(`Failed: ${pg.label}`, err);
    }

    // Update progress bar
    const pct = Math.round((doneCount / total) * 100);
    document.getElementById('buildProgressFill').style.width = pct + '%';
    document.getElementById('buildStatusCount').textContent = `${doneCount} / ${total}`;
  }

  // All done
  const successCount = builtPages.length;
  const allOk = successCount === total;
  document.getElementById('buildStatusTitle').textContent =
    allOk ? `‚úì All ${total} pages built successfully` : `‚ö† ${successCount} of ${total} pages built`;
  document.getElementById('buildProgressFill').style.background =
    allOk ? 'var(--success)' : 'var(--warning)';
  document.getElementById('buildPagesBtn').disabled = false;
  document.getElementById('buildPagesBtn').textContent = '‚ö° Rebuild All Pages';
  isBuilding = false;

  if (successCount > 0) {
    siloZip = new JSZip();
    const folder = siloZip.folder(pillarSlug);
    builtPages.forEach(pg => folder.file(pg.filename, pg.content));
    if (siloBlueprint) folder.file('_silo-blueprint.txt', siloBlueprint);
    document.getElementById('downloadZipBtn').style.display = 'inline-flex';
    showToast('success', `${successCount} pages ready ‚Äî download zip!`);
  }
}

// ‚îÄ‚îÄ‚îÄ STATUS ROW HELPERS ‚îÄ‚îÄ‚îÄ
function buildStatusRow(i, label, tag, state, note) {
  const icons  = { pending: '‚óã', active: '‚óâ', done: '‚úì', error: '‚úó' };
  const colors = { pending: 'var(--subtle)', active: 'var(--accent)', done: 'var(--success)', error: 'var(--error)' };
  return `<div id="buildRow_${i}" style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;">
    <span id="buildRowIcon_${i}" style="font-size:13px;color:${colors[state]};width:14px;text-align:center;flex-shrink:0;">${icons[state]}</span>
    <span style="flex:1;color:var(--text);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</span>
    <span style="font-size:11px;color:var(--muted);font-family:var(--mono);flex-shrink:0;">${tag}</span>
    <span id="buildRowNote_${i}" style="font-size:11px;color:var(--muted);font-family:var(--mono);min-width:90px;text-align:right;flex-shrink:0;">${note}</span>
  </div>`;
}

function setRowState(i, state, note) {
  const icons  = { pending: '‚óã', active: '‚óâ', done: '‚úì', error: '‚úó' };
  const colors = { pending: 'var(--subtle)', active: 'var(--accent)', done: 'var(--success)', error: 'var(--error)' };
  const iconEl = document.getElementById(`buildRowIcon_${i}`);
  const noteEl = document.getElementById(`buildRowNote_${i}`);
  if (iconEl) { iconEl.textContent = icons[state]; iconEl.style.color = colors[state]; }
  if (noteEl) { noteEl.textContent = note; noteEl.style.color = state === 'error' ? 'var(--error)' : 'var(--muted)'; }
}

// ‚îÄ‚îÄ‚îÄ ZIP DOWNLOAD ‚îÄ‚îÄ‚îÄ
async function downloadSiloZip() {
  if (!siloZip) { showToast('error', 'No pages built yet'); return; }
  const pillarSlug = document.getElementById('pillarSlug').value.trim() || 'silo';
  showToast('success', 'Packing zip...');
  const blob = await siloZip.generateAsync({ type: 'blob', compression: 'DEFLATE' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${pillarSlug}-silo-pages.zip`;
  a.click();
  setTimeout(() => showToast('success', 'Zip downloaded!'), 400);
}

// ‚îÄ‚îÄ‚îÄ PAGE HTML SHELL ‚îÄ‚îÄ‚îÄ
function wrapSiloPageShell(title, url, bodyContent) {
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${title}</title>
<link rel="canonical" href="${url}">
</head>
<body>
${bodyContent}
</body>
</html>`;
}

// ‚îÄ‚îÄ‚îÄ SILO-AWARE PAGE CONTENT PROMPT ‚îÄ‚îÄ‚îÄ
function buildSiloPagePrompt(focusKw, secKws, pageType, siteName, url, tone, schemas, pageTitle, wc, internalLinks, pillarSlug, isPillar, colors) {
  const slug = url.split('/').filter(Boolean).pop() || toSlug(focusKw);
  const title = pageTitle || (focusKw + ' | ' + siteName);
  const secList = secKws.length ? secKws.join(', ') : 'none specified';
  const schemaList = schemas.join(', ');
  const brandColorInstruction = colors
    ? `BRAND COLORS ‚Äî read the following carefully and apply each instruction to the CSS:
"${colors}"
Rules for interpreting:
- If specific heading levels are mentioned (e.g. "H1: #1d4ed8, H2: #374151"), apply each color ONLY to that heading level
- If hex codes are given, use them exactly as provided
- If colors are described in words (e.g. "dark navy", "forest green"), choose the closest appropriate hex value
- If a URL is given, infer the brand colors from the domain or brand identity
- If "CTA" or "CTA box" is mentioned, apply that color as the CTA box background with auto-contrasting text (white or black)
- If only one color is given with no tag specified, apply it to all headings and derive a complementary CTA color
- If H1/H2/H3 are specified separately, give each its own color rule in the CSS ‚Äî do not group them
- Always ensure text contrast is accessible (WCAG AA minimum)`
    : `Use clean, professional default styling. Headings in #111111, CTA box in #2563eb with white text.`;

  const diviMode = typeof siloDiviMode !== 'undefined' && siloDiviMode;
  const scopeId = 'pf-' + slug.slice(0,6).replace(/[^a-z0-9]/g,'') + '-' + Math.random().toString(36).slice(2,6);
  const stylingInstruction = diviMode
    ? `STYLING ‚Äî DIVI MODE:
- DO NOT include any <style> blocks whatsoever
- DO NOT add inline style="" attributes on any element
- DO NOT include any <script> blocks for FAQ accordion
- Wrap ALL content in: <div id="${scopeId}" class="pf-content">...</div>
- Use class names: .wp-seo-faq, .wp-seo-cta, .wp-seo-intro, .wp-seo-section
- Divi theme builder controls all colors, fonts, spacing, layout
- CTA box: <div class="wp-seo-cta"><p>text here</p></div> ‚Äî no inline styles`
    : `STYLING ‚Äî SCOPED CSS (follow every rule exactly or WordPress will break):

STEP 1 ‚Äî Wrap ALL content in one outer div:
<div id="${scopeId}" class="pf-content">
  ...everything goes here...
</div>

CRITICAL: Do NOT write any <style> block before this wrapper div.
Do NOT add any <style> block with body{}, *{}, img{}, a{}, or any unscoped rules anywhere.
The ONLY <style> block allowed is one that uses exclusively #${scopeId} prefixed selectors.

STEP 2 ‚Äî Write a <style> block BEFORE that wrapper. Every selector MUST start with #${scopeId}:
CORRECT:   #${scopeId} h1 { color: #1d4ed8; }
CORRECT:   #${scopeId} .wp-seo-cta { background: #f59e0b; }
WRONG:     h1 { color: #1d4ed8; }  ‚Äî breaks WordPress theme
WRONG:     .wp-seo-cta { background: #f59e0b; }  ‚Äî leaks globally

ABSOLUTE BANS:
- NEVER target body, html, *, :root
- NEVER use !important
- NEVER write a selector without the #${scopeId} prefix

STEP 3 ‚Äî FIRST rule inside the style block MUST be this scoped reset to neutralise
any WordPress/Divi/theme global CSS bleeding into the content:
#${scopeId} {
  all: initial;
  display: block;
  box-sizing: border-box;
  max-width: 860px;
  margin: 0 auto;
  padding: 0 20px 40px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 1rem;
  line-height: 1.7;
  color: #333;
}
#${scopeId} * {
  box-sizing: border-box;
}
#${scopeId} h1, #${scopeId} h2, #${scopeId} h3,
#${scopeId} h4, #${scopeId} h5, #${scopeId} h6 {
  all: unset;
  display: block;
  font-weight: 700;
  line-height: 1.3;
  margin: 0.8em 0 0.4em;
}
#${scopeId} p {
  all: unset;
  display: block;
  margin: 0 0 1.2em;
  line-height: 1.7;
}
#${scopeId} a {
  all: unset;
  cursor: pointer;
  text-decoration: underline;
}
#${scopeId} img {
  all: unset;
  display: block;
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 1em 0;
}
#${scopeId} ul, #${scopeId} ol {
  all: unset;
  display: block;
  padding-left: 1.6em;
  margin: 0 0 1.2em;
}
#${scopeId} li {
  all: unset;
  display: list-item;
  margin-bottom: 0.4em;
}
#${scopeId} table {
  all: unset;
  display: table;
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1.5em;
}
#${scopeId} th, #${scopeId} td {
  all: unset;
  display: table-cell;
  padding: 8px 12px;
  border: 1px solid #e2e8f0;
  text-align: left;
}

Then AFTER the reset, write ALL your heading sizes, brand colors, CTA box, FAQ styles etc ‚Äî all scoped to #${scopeId}

${brandColorInstruction}

MEDIA QUERIES: scope ALL selectors inside @media too:
@media (max-width:768px) { #${scopeId} h1 { font-size:1.5rem; } }`;

  const linkBlock = internalLinks.length
    ? `REQUIRED INTERNAL LINKS ‚Äî embed ALL of these as natural contextual anchor links within the body copy:
${internalLinks.map(l => `  ‚Ä¢ Anchor text: "${l.text}"  ‚Üí  href="${l.url}"`).join('\n')}

${isPillar
  ? 'This is the PILLAR PAGE of this silo. You MUST include a dedicated section titled "In This Guide" or "Explore This Silo" that links out to every child post listed above with a one-sentence teaser each.'
  : 'This is a CHILD POST inside a content silo. You MUST link back to the pillar page naturally in the body copy ‚Äî ideally in the intro or a relevant section. This is mandatory for silo architecture.'
}`
    : '';

  return `You are an expert SEO content writer and WordPress developer. Generate WORDPRESS BODY CONTENT ONLY ‚Äî no full HTML page, no <html>, no <head>, no header, no nav, no footer.

INPUTS:
- Focus Keyword: "${focusKw}"
- Page Title: "${title}"
- Secondary Keywords: ${secList}
- Page Type: ${pageType}
- Site Name: ${siteName}
- Target URL: ${url}
- Tone: ${tone}
- Target Word Count: ${wc} words minimum (HARD REQUIREMENT)
- Schema Types: ${schemaList}
- Silo Root: /${pillarSlug}/

${linkBlock}

OUTPUT FORMAT ‚Äî WORDPRESS BODY ONLY:

SECTION 1 ‚Äî SEO META COMMENT:
<!-- SEO META
================================================================
TITLE TAG:
${title}

META DESCRIPTION:
[Write 130-155 character description with "${focusKw}" and a CTA]

CANONICAL URL:
${url}

FOCUS KEYWORD: ${focusKw}

og:title: ${title}
og:description: [same as META DESCRIPTION]
og:url: ${url}
og:type: article
og:image: https://placehold.co/1200x630?text=${slug}

twitter:card: summary_large_image
twitter:title: ${title}
twitter:description: [same as META DESCRIPTION]
twitter:image: https://placehold.co/1200x630?text=${slug}
================================================================ -->

SECTION 2 ‚Äî JSON-LD SCHEMA:
<script type="application/ld+json"> block with: ${schemaList}
Include FAQPage with 5+ real Q&As. Include BreadcrumbList (3 levels).

SECTION 3 ‚Äî PAGE BODY CONTENT:
- ONE <h1> with focus keyword "${focusKw}"
- 5+ <h2> subheadings using secondary keywords
- Multiple <h3> under h2s
- Keyword "${focusKw}" in first paragraph
- ${wc}+ words of real, detailed content (NO lorem ipsum)
- EVERY <img> must have alt="[descriptive]" ‚Äî NEVER omit alt
- Use https://placehold.co/800x400?text=${slug} for main image
- Embed ALL required internal links from the section above naturally in body copy
- FAQ section with 5+ Q&As
- DO NOT include header/nav/footer/breadcrumb UI/sidebar

${stylingInstruction}`;
}
</script>
</body>
</html>
